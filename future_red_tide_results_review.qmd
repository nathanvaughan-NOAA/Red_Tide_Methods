---
format:
  html:
    toc: true
    toc_location: right
editor: source
execute:
  echo: false
---

# Comparing Future Red Tide Scenarios

For this test run, I took the SEDAR Red Grouper stock assessment and used SSMSE to introduce future red tide events in the OM and EM. There were 6 total scenarios:

1.  default: the base stock assessment with red tide events in 2005 and 2014.\
2.  red tide random 10: I used a custom function to generate 10 random red tide events in the projected years.\
3.  red tide random 25: I used a custom function to generate 25 random red tide events in the projected years.\
4.  red tide regular 3: I added a red tide event every 3 years.
5.  red tide regular 5: I added a red tide event every 5 years.
6.  red tide regular 5 mortality 5: I added a red tide event every 5 years and set the OM mortality to 0.5.

Import the results and summary files from the cloud.

```{r, include = FALSE}
library(tidyverse)
library("nmfspalette")
library(patchwork)
library(knitr)
library(kableExtra)

#name of the OM
OM_name <- "default"
run_SSMSE_dir <- file.path("C:/Users/apn26/Documents/CIMAS/Personal Notes/test_cloud_computing/testing_cloud")
default <- file.path(run_SSMSE_dir, OM_name)

#name of the results files
results_name <- "_multirun_cpuefix_clean"

#pull the summary and dat files, the dat file isn't actually that important.  
cc_storage <- file.path("C:/Users/apn26/Documents/CIMAS/Personal Notes/cc_storage/")
summary <- readRDS(file = file.path("C:/Users/apn26/Documents/CIMAS/Personal Notes/cc_storage/", paste0("results_summary", results_name, ".rda")))
dat <- r4ss::SS_readdat(file.path(default, "red_grouper_1986_2017_RedTideFleet.dat"))


#remove "Base" model 
summary$ts <- summary$ts %>%
  filter(model_run != "", !str_detect(model_run, "Base"))
summary$dq <- summary$dq %>%
  filter(model_run != "", !str_detect(model_run, "Base"))
summary$scalar <- summary$scalar %>%
  filter(model_run != "", !str_detect(model_run, "Base"))

#rename the OM if it's different from default
OM_name <- "default"

```

```{r}

scen_list <- unique(summary$ts$scenario)
scen_list<- scen_list[-1]

```

# Raw Data

## Reviewing time series plots

List of the things we can plot with the ts_plot_variable function:

```{r, echo = FALSE}

ts_plot_variable <- function(summary, variable = SpawnBio, run_res_path, save = TRUE) {
  
  # identify the last year sampled by SSMSE
  max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
    summary$ts$model_run %>% 
      unique() %>% # get the list of unique model runs
      str_sub(-4) %>% # select last 4 characters of EM names
      {
        ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
      } %>% # check the last 4 characters are numbers or make NA
      max(na.rm = TRUE) # find the max EM year
  )
  
  # make a list that includes the OM and all max_sample_year EMs  
  key_models <- unique(summary$ts$model_run)
  key_models <- key_models[grepl("OM", key_models) | grepl(as.character(max_sample_year), key_models)]
  
  # set the OM to bright orange, and all the other models to black
  color_values <- setNames(
    ifelse(grepl("OM", key_models), "#D65F00", "black"),
    key_models
  )
  
  var_name <- rlang::as_name(enquo(variable))
  title <- (paste(var_name,"timeseries by scenario"))
  
  ssb_ts_plot <- summary$ts %>% 
    filter(model_run %in% key_models) %>% #filters to just OM and max year runs
     ggplot(aes(x = year, y = {{ variable }})) +
     geom_vline(xintercept = dat$endyr, color = "gray") +
     geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
     geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
     geom_line( aes(linetype = as.character(iteration), color = model_run))+
     scale_color_manual(values = color_values) +
     scale_linetype_manual(values = rep("solid", 100)) +
     guides(linetype = FALSE) +
     labs(color = "Model Runs") +
     ggtitle(title) +
     facet_wrap(~scenario, labeller = labeller(scenario = function(x) gsub("_", " ", x))) +
     theme_bw()
  
  
  if(save == TRUE){
    ggsave(file.path(run_res_path, "plots", paste0(gsub(" ", "_", title), ".png")),
           width = 8, height = 6, units = "in", device = "png")
  }
  
  return(ssb_ts_plot)
  
}

colnames(summary$ts)

```

Here are the time series plots:

::: panel-tabset
### Red tide mortality

```{r, echo = FALSE, warning = FALSE}
run_res_path <- file.path(run_SSMSE_dir, "results")

ts_plot_variable(summary, F_5, run_res_path, save = TRUE)
```

Figure 1. The fishing mortality of fleet 5 over time.  This line plot demonstrates the frequency and magnitude of red tide events in the EM (black) and OM (orange) for each scenario. All 10 iterations of the OM and EM are plotted simultaneously so peaks are representative of the iteration with the highest value and not the overall trend.  The OMs have fixed magnitudes and the EMs estimate a F_5 that varies in magnitude but has a median close to the fixed value in the OM.  


```{r, echo = FALSE, warning = FALSE}

  max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
    summary$ts$model_run %>% 
      unique() %>% # get the list of unique model runs
      str_sub(-4) %>% # select last 4 characters of EM names
      {
        ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
      } %>% # check the last 4 characters are numbers or make NA
      max(na.rm = TRUE) # find the max EM year
  )
  
  # make a list that includes the OM and all max_sample_year EMs  
  key_models <- unique(summary$ts$model_run)
  key_models <- key_models[grepl("OM", key_models) | grepl(as.character(max_sample_year), key_models)]
  

F_5_summary <- summary$ts %>%
  filter(model_run %in% key_models, F_5 > 0, year > 2017) %>% #this might exclude 0's when there is supposed to be a red tide.  
  group_by(model_run, scenario) %>%
  reframe(mean_F_5 = round(mean(F_5), 3),
          sd_F_5 = round(sd(F_5), 3),
          median_F_5 = round(median(F_5),3))

```

Table 1. A summary of the Operating Model fleet 5 fishing mortality. These statistics only include values where F_5 > 0.   

```{r, echo = FALSE, warning = FALSE}
F_5_summary %>%
  filter(str_detect(model_run, "OM")) %>%
  select(!model_run) %>%
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Mean", "Standard Dev", "Median"),
    align = c("l", "c", "c", "c") # Align columns (left, center, center, center)
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )
```


Table 2. A summary of the Estimated Model fleet 5 fishing mortality. These statistics only include values where F_5 > 0.   

```{r, echo = FALSE, warning = FALSE}
F_5_summary %>%
  filter(str_detect(model_run, "EM")) %>%
  select(!model_run) %>%
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Mean", "Standard Dev", "Median"),
    align = c("l", "c", "c", "c") # Align columns (left, center, center, center)
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )
```

### Red tide dead biomass

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, deadB_5, run_res_path, save = TRUE)
```

Figure 2. The biomass of fish killed by red tide over time.  This line plot demonstrates the biomass removed by red tide.  While fishing mortality is fixed in the OM, the biomass removed can vary depending on the available biomass.  

### Spawning Stock Biomass

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, SpawnBio, run_res_path, save = TRUE)
```

Figure 3. The spawning stock biomass (SSB) over time.  These plots best demonstrate the effects of the red tide mortality on the spawning availability, with the increased frequency and magnitude of red tides resulting in lower SSB.  

### Retained Biomass

```{r, echo = FALSE, warning = FALSE}

# model run selection: include OM, max year runs
model_names <- tibble(names = unique(summary$ts$model_run))

# select only the max year runs
last_year_models <- model_names %>%
  mutate(
    numbers = str_extract_all(names, "\\d+"), # Extract all numbers as a list of characters
    max_number = sapply(numbers, function(x) max(as.numeric(x))) # Find the max number in each list
  ) %>%  
  filter(max_number == max(max_number, na.rm = TRUE)) %>%
  select(names)

ssb_ts_plot <- summary$ts %>% 
  filter(str_detect(model_run, "OM")|model_run %in% last_year_models$names) %>% #filters to just OM and max year runs
  mutate(retainB_all = select(., starts_with("retainB")) %>% rowSums()) %>%
  ggplot(aes(x = year, y = retainB_all)) +
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
  scale_color_manual(values = c("#D65F00", "black",'blue','green')) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE) +
  labs(color = "Model Runs") +
  facet_wrap(. ~ scenario, ncol=2, nrow=4) +
  ggtitle("All retained biomass overtime") +
  theme_bw()
ssb_ts_plot

```

Figure 4. The total retained biomass of the fishery over time.  This is the sum of all columns starting with "RetainB" so it does not include discards or red tide mortality.  This plot demonstrates how impactful high mortality events can reduce catch.  

:::

::: panel-tabset

### F_1
```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, F_1, run_res_path, save = TRUE)
```


### F_2
```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, F_2, run_res_path, save = TRUE)
```

### F_4

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, F_4, run_res_path, save = TRUE)
```

:::

## Reviewing derived quantities

Additional time series plots but derived quantities. Below is a list of all the derived quantity variables:

```{r, echo = FALSE, warning = FALSE}

dq_plot_variable <- function(summary, variable = Value.SSB, run_res_path, save = TRUE) {
  
  # identify the last year sampled by SSMSE
  max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
    summary$dq$model_run %>% 
      unique() %>% # get the list of unique model runs
      str_sub(-4) %>% # select last 4 characters of EM names
      {
        ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
      } %>% # check the last 4 characters are numbers or make NA
      max(na.rm = TRUE) # find the max EM year
  )
  
  # make a list that includes the OM and all max_sample_year EMs  
  key_models <- unique(summary$dq$model_run)
  key_models <- key_models[grepl("OM", key_models) | grepl(as.character(max_sample_year), key_models)]
  
  # set the OM to bright orange, and all the other models to black
  color_values <- setNames(
    ifelse(grepl("OM", key_models), "#D65F00", "black"),
    key_models
  )
  
  var_name <- rlang::as_name(enquo(variable))
  title <- (paste(var_name,"timeseries by scenario"))
  
  ssb_dq_plot <- summary$dq %>% 
    filter(model_run %in% key_models) %>% #filters to just OM and max year runs
     ggplot(aes(x = year, y = {{ variable }})) +
     geom_vline(xintercept = dat$endyr, color = "gray") +
     geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
     geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
     geom_line( aes(linetype = as.character(iteration), color = model_run))+
     scale_color_manual(values = color_values) +
     scale_linetype_manual(values = rep("solid", 100)) +
     guides(linetype = FALSE) +
     labs(color = "Model Runs") +
     ggtitle(title) +
     facet_wrap(~scenario, labeller = labeller(scenario = function(x) gsub("_", " ", x))) +
     theme_bw()
  
  
  if(save == TRUE){
    ggsave(file.path(run_res_path, "plots", paste0(gsub(" ", "_", title), ".png")),
           width = 8, height = 6, units = "in", device = "png")
  }
  
  return(ssb_dq_plot)
  
}

colnames(summary$dq)


```

::: panel-tabset
### Recruitment

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.Recr, run_res_path = run_res_path)
```

Figure 5. Recruitment over time by scenario.  Recruitment is determined by the Beverton-Holt equation using steepness, R0, and SigmaR.  Steepness is fixed at 0.99.  R0 and SigmaR were estimated in SEDAR 61 and SEDAR 88.  

### SSB

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, run_res_path = run_res_path)
```
Figure 6 (same as figure 3). The spawning stock biomass (SSB) over time.  These plots best demonstrate the effects of the red tide mortality on the spawning availability, with the increased frequency and magnitude of red tides resulting in lower SSB.  

### SPR Ratio

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.SPRratio, run_res_path = run_res_path)
```

Figure 7. The Spawning Potential Ratio (SPR) over time by scenario.  This is the spawning output with fishing:the spawning output without fishing so it is a higher value when the reproductive potential is high.  SPR tends to spike when there is a red tide event.  

### B Ratio

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.Bratio, run_res_path = run_res_path)
```

Figure 8. The BRatio over time by scenario.  The BRatio is the current SSB over the unfished SSB so the value indicates the status of the SSB relative to a unfished scenario.  This can be usefull if there is a reference point for BRatio like 0.2 as a cut-off for overfished.  Higher frequencies and magnitudes of red tide cause a BRatio less than 0.2 more often.  

### F

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.F, run_res_path = run_res_path)
```

Figure 9. The total fishing mortality over time by scenario.  The default scenario indicates that fishing over time has low variability.  When Red tide events are introduced,  the variability increases drastically as F includes red tide mortality.  Since red tide is a by-catch fleet, it is included in this value.

:::

# Ratio Time Series

## Fishing mortalities

My new method for plotting EM:OM involves creating separate OM and EM data frames, joining them by year, scenario, and iteration, then dividing the EM value/ OM value for every variable.  That way when plotted it is truly the EM for each model run, year and iteration divided by the OM from the same year and iteration but one model run.  If the om and em value are zero I changed the ratio to 1 because that means that the EM = OM.  

```{r}

#set up the OM and EM dataframes, join them, and calculate the EM:OM ratio for each available value

OM_runs <- summary$ts %>%
  filter(str_detect(model_run, "OM"))
  
EM_runs <- summary$ts %>%
  filter(str_detect(model_run, "EM"))

ratio_df <- left_join(EM_runs, OM_runs,
                      by = c("year", "scenario", "iteration"),
                      suffix = c("_em", "_om")) %>%
  mutate(across(
    .cols = where(is.numeric) & ends_with("_om"),
    .fns = ~ {
      # Get the name of the corresponding '_em' column
      em_col_name <- str_replace(cur_column(), "_om", "_em")
      # Get the value from the '_em' column for the current row
      em_value <- get(em_col_name)
      # Get the value from the current '_om' column (represented by .x)
      om_value <- .x

      # Conditional logic:
      # If both '_em' and '_om' values are 0, set the ratio to 1.
      # Otherwise, perform the division.
      if_else(em_value == 0 & om_value == 0, 1, em_value / om_value)
    },
    .names = "{str_remove(.col, '_om')}_ratio"
  )) %>%
  select(year, scenario, iteration, model_run = model_run_em, ends_with("_ratio"))

```


```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1_ratio, F_2_ratio, F_3_ratio, F_4_ratio, F_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year,
      ratio_F = if_else(fleet == "F_3", 1, ratio_F)
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = ratio_F, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years") +
    facet_wrap( ~ fleet) +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
f_ts_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
f_ts_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
f_ts_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
f_ts_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
f_ts_plots[[5]]
```
:::

Figure 10. Each fleet's fishing mortality ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  F_5 is consistently underestimated, it is more underestimated in future years where there is less data.  

## F_5

A zoomed in look at just F_5 from the previous plots.  

```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1_ratio, F_2_ratio, F_3_ratio, F_4_ratio, F_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year,
      ratio_F = if_else(fleet == "F_3", 1, ratio_F)
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) %>%
    filter(fleet == "F_5")
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    filter(fleet == "F_5") %>%
    ggplot() +
    geom_point(aes(y = ratio_F, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years") +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
f_ts_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
f_ts_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
f_ts_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
f_ts_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
f_ts_plots[[5]]
```
:::

Figure 11. Red tide mortality ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  Red tide mortality is consistently underestimated, it is more underestimated in future years where there is less data.  


## Biomass

```{r}

plot_biomass_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(retainB_1_ratio, retainB_2_ratio, retainB_3_ratio, retainB_4_ratio, deadB_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_Biomass") %>%
    mutate(fleet = str_sub(fleet, start = 9, end = 9)) %>%
    select(fleet, year, ratio_Biomass, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year,
      ratio_Biomass = if_else(fleet == "3", 1, ratio_Biomass), 
      fleet = if_else(fleet == "r", "5", fleet)
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_Biomass, na.rm = TRUE),
      lower_quartile = quantile(ratio_Biomass, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_Biomass, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = ratio_Biomass, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of Biomass (EM:OM)") + xlab("Years") +
    facet_wrap(~fleet) +
    theme_bw()
  
  rt_terminal_ratio
  
}

biomass_ts_plots <- map(scen_list, plot_biomass_ts)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
biomass_ts_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
biomass_ts_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
biomass_ts_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
biomass_ts_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
biomass_ts_plots[[5]]
```
:::

Figure 12. Biomass ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  Red tide mortality is consistently underestimated, it is more underestimated in future years where there is less data.  

## Recruitment

```{r, warning=FALSE}
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, Recruit_0_ratio, iteration, model_run, scenario) %>%
    rename(ratio_recruitment = Recruit_0_ratio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_recruitment, na.rm = TRUE),
      lower_quartile = quantile(ratio_recruitment, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_recruitment, 0.75, na.rm = TRUE)
    ) 
  
  
  recruitment_ratio_plot <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = ratio_recruitment, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("Recruitment Ratios") +
    ylab("Ratio of recruitment (EM:OM)") + xlab("Years") +
    facet_wrap(~scenario) +
    theme_bw()
  
  recruitment_ratio_plot

```

Figure 13. Recruitment ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  Recruitment is not over or underestimated, but there are a few outliers where the EM overestimated by 10x.   

## SSB

```{r, warning=FALSE}
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, SpawnBio_ratio, iteration, model_run, scenario) %>%
    rename(ratio_ssb = SpawnBio_ratio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_ssb, na.rm = TRUE),
      lower_quartile = quantile(ratio_ssb, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_ssb, 0.75, na.rm = TRUE)
    ) 
  
  
  ssb_ratio_plot <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = ratio_ssb, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("SSB Ratios") +
    ylab("Ratio of SSB (EM:OM)") + xlab("Years") +
    facet_wrap(~scenario) +
    theme_bw()
  
  ssb_ratio_plot

```

Figure 14. SSB ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  SSB is not over or underestimated, but it is more likely to be overestimated, the later years are overestimated.   SSB may spike in response to red tide events based on the red_tide_regular_5_mortality_5 scenario.  

# Terminal Year

Plotting the same ratios as above but by the "time from the terminal year" instead of year.  These plots use mean instead of median because there were too many "years until terminal" with no red tide which skewed to 1 and resulted in straight lines.  F_5 in all of these plots was a straight line when median was used.  

## Fishing Mortality

```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1_ratio, F_2_ratio, F_3_ratio, F_4_ratio, F_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year,
      ratio_F = if_else(fleet == "F_3", 1, ratio_F)
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    # Group by year to calculate stats for each year
    group_by(years_until_terminal, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    ggplot() +
    geom_point(aes(y = ratio_F, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years from terminal") +
    facet_wrap( ~ fleet) +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
f_ts_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
f_ts_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
f_ts_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
f_ts_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
f_ts_plots[[5]]
```
:::

Figure 15. Each fleet's fishing mortality ratio (EM:OM) over the years from terminal year by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  F_5 is consistently underestimated, there is higher variation where there is less data.  

## F_5

A zoomed in look at just F_5 from the previous plots.  

```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1_ratio, F_2_ratio, F_3_ratio, F_4_ratio, F_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year,
      ratio_F = if_else(fleet == "F_3", 1, ratio_F)
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    # Group by years_until_terminal to calculate stats for each year
    group_by(years_until_terminal, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) %>%
    filter(fleet == "F_5")
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    filter(fleet == "F_5") %>%
    ggplot() +
    geom_point(aes(y = ratio_F, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years from terminal") +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
f_ts_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
f_ts_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
f_ts_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
f_ts_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
f_ts_plots[[5]]
```
:::

Figure 16. Red tide mortality ratio (EM:OM) over the years from terminal year by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  F_5 is consistently underestimated, there is higher variation where there is less data.  


## Biomass

```{r}

plot_biomass_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(retainB_1_ratio, retainB_2_ratio, retainB_3_ratio, retainB_4_ratio, deadB_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_Biomass") %>%
    mutate(fleet = str_sub(fleet, start = 9, end = 9)) %>%
    select(fleet, year, ratio_Biomass, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year,
      ratio_Biomass = if_else(fleet == "3", 1, ratio_Biomass), 
      fleet = if_else(fleet == "r", "5", fleet)
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    # Group by year to calculate stats for each year
    group_by(years_until_terminal, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_Biomass, na.rm = TRUE),
      lower_quartile = quantile(ratio_Biomass, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_Biomass, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    ggplot() +
    geom_point(aes(y = ratio_Biomass, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of Biomass (EM:OM)") + xlab("Years from terminal") +
    facet_wrap(~fleet) +
    theme_bw()
  
  rt_terminal_ratio
  
}

biomass_ts_plots <- map(scen_list, plot_biomass_ts)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
biomass_ts_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
biomass_ts_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
biomass_ts_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
biomass_ts_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
biomass_ts_plots[[5]]
```
:::

Figure 17. Biomass ratio (EM:OM) over the years from terminal year by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  Red tide mortality is consistently underestimated, it is more underestimated in years where there is less data.  

## Recruitment

```{r, warning=FALSE}

  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, Recruit_0_ratio, iteration, model_run, scenario) %>%
    rename(ratio_recruitment = Recruit_0_ratio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0 ) %>%
    # Group by year to calculate stats for each year
    group_by(years_until_terminal, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_recruitment, na.rm = TRUE),
      lower_quartile = quantile(ratio_recruitment, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_recruitment, 0.75, na.rm = TRUE)
    ) 
  
  
  recruitment_ratio_plot <- fleet_ratios %>%
    filter(years_until_terminal > 0 ) %>%
    ggplot() +
    geom_point(aes(y = ratio_recruitment, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("Recruitment Ratios") +
    ylab("Ratio of recruitment (EM:OM)") + xlab("Years from terminal") +
    facet_wrap(~scenario) +
    theme_bw()
  
  recruitment_ratio_plot

```

Figure 18. Recruitment ratio (EM:OM) over time by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  Recruitment is overestimated in the terminal year of the model run.  

## SSB

```{r, warning=FALSE}
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, SpawnBio_ratio, iteration, model_run, scenario) %>%
    rename(ratio_ssb = SpawnBio_ratio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0 ) %>%
    # Group by year to calculate stats for each year
    group_by(years_until_terminal, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_ssb, na.rm = TRUE),
      lower_quartile = quantile(ratio_ssb, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_ssb, 0.75, na.rm = TRUE)
    ) 
  
  
  ssb_ratio_plot <- fleet_ratios %>%
    filter(years_until_terminal > 0 ) %>%
    ggplot() +
    geom_point(aes(y = ratio_ssb, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("SSB Ratios") +
    ylab("Ratio of SSB (EM:OM)") + xlab("Years from terminal") +
    facet_wrap(~scenario) +
    theme_bw()
  
  ssb_ratio_plot

```

Figure 19. SSB ratio (EM:OM) over the years from the terminal year by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  SSB is underestimated when red tide is introduced, with higher variability in the terminal year of the default model.  

# Management

## Term Plots

::: panel-tabset
```{r}

# identify the last year sampled by SSMSE
max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
  summary$ts$model_run %>%
    unique() %>% # get the list of unique model runs
    str_sub(-4) %>% # select last 4 characters of EM names
    {
      ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
    } %>% # check the last 4 characters are numbers or make NA
    max(na.rm = TRUE) # find the max EM year
)
  
# make a list that includes the OM and all max_sample_year EMs
key_models <- unique(summary$ts$model_run)

color_values <- setNames(ifelse(grepl("OM", key_models), "#D65F00", "black"), key_models)

scen_ts_plots <- function(scen = "default"){

  scen_ts <- summary$ts %>%
    filter(scenario == scen) %>%
    mutate(retainB_all = select(., starts_with("retainB")) %>% rowSums()) %>%
    pivot_longer(cols = c("SpawnBio", "F_5", "retainB_all"),
                 names_to = "variables") %>%
    select(year, value, variables, iteration, model_run)
  
  scen_dq <- summary$dq %>%
    filter(scenario == scen) %>%
    pivot_longer("Value.SPRratio", names_to = "variables") %>%
    select(year, value, variables, iteration, model_run)

  scen_merge <- rbind(scen_ts,scen_dq)
    
t_plot <- scen_merge %>%
  ggplot(aes(x = year, y = value)) +
  geom_line( aes(linetype = as.character(iteration), color = model_run))+
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
  geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
  facet_wrap(~variables, ncol = 1, scales = "free") +
  scale_color_manual(values = color_values) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE, color = FALSE) +
  labs(color = "Model Runs") +
  ggtitle("", subtitle = "Long-term")+
  theme_bw()

scen_years = c(2020,2023,2026, "OM")

t_plot_short <- scen_merge %>%
  filter(str_detect(model_run, str_c(scen_years, collapse = "|"))) %>%
  ggplot(aes(x = year, y = value)) +
  geom_line( aes(linetype = as.character(iteration), color = model_run))+
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
  geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
  facet_wrap(~variables, ncol = 1, scales = "free") +
  scale_color_manual(values = color_values) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE, color=FALSE) +
  labs(color = "Model Runs") +
  xlim(2000, 2030)+
  ggtitle(scen, subtitle = "Short-term")+
  theme_bw()

t_plot_short + t_plot
  
}

all_term_plots<- map(unique(summary$ts$scenario), scen_ts_plots)

```

### default

```{r, warning=FALSE}
all_term_plots[[1]]
```

### 10 random red tides

```{r, warning=FALSE}
all_term_plots[[2]]
```

### 25 random red tides

```{r, warning=FALSE}
all_term_plots[[3]]
```

### Red tide every 3 years

```{r, warning=FALSE}
all_term_plots[[4]]
```

### Red tide every 5 years

```{r, warning=FALSE}
all_term_plots[[5]]
```

### Mortality = 0.5

```{r, warning=FALSE}
all_term_plots[[6]]
```
:::

Figure 20. Term plots are meant to be a "short term" (2000-2030) and "long term" (1989-2067) look at a few key parameters from the time series dataset.  These plots demonstrate that red tide events correspond with SPR Ratio spikes, and can slowly decrease retained biomass or spawning biomass in the short term.  In the long term, there are no trends.  

## Management Term Plots

::: panel-tabset
```{r}

# identify the last year sampled by SSMSE
max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
  summary$ts$model_run %>%
    unique() %>% # get the list of unique model runs
    str_sub(-4) %>% # select last 4 characters of EM names
    {
      ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
    } %>% # check the last 4 characters are numbers or make NA
    max(na.rm = TRUE) # find the max EM year
)
  
# make a list that includes the OM and all max_sample_year EMs
key_models <- unique(summary$ts$model_run)

color_values <- setNames(ifelse(grepl("OM", key_models), "#D65F00", "grey"), key_models)

scen_ts_plots <- function(scen = "default"){

  scen_ts <- summary$ts %>%
    filter(scenario == scen) %>%
    mutate(retainB_all = select(., starts_with("retainB")) %>% rowSums()) %>%
    pivot_longer(cols = c("SpawnBio", "F_5", "retainB_all"),
                 names_to = "variables") %>%
    select(year, value, variables, iteration, model_run)
  
  scen_dq <- summary$dq %>%
    filter(scenario == scen) %>%
    pivot_longer("Value.SPRratio", names_to = "variables") %>%
    select(year, value, variables, iteration, model_run)

  scen_merge <- rbind(scen_ts,scen_dq)
    
t_plot <- scen_merge %>%
  ggplot(aes(x = year, y = value)) +
  geom_line( aes(linetype = as.character(iteration), color = model_run), alpha = 0.2)+
  stat_summary(fun = median, geom = "line",  aes(color = model_run),  linewidth = 1.2) +
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
  geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
  facet_wrap(~variables, ncol = 1, scales = "free") +
  scale_color_manual(values = color_values) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE, color = FALSE) +
  labs(color = "Model Runs") +
  ggtitle("", subtitle = "Long-term")+
  theme_bw()

scen_years = c(2020,2023,2026, "OM")

t_plot_short <- scen_merge %>%
  filter(str_detect(model_run, str_c(scen_years, collapse = "|"))) %>%
  ggplot(aes(x = year, y = value)) +
  geom_line( aes(linetype = as.character(iteration), color = model_run))+
  stat_summary(fun = median, geom = "line",  aes(color = model_run),  linewidth = 1.2) +
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
  geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
  facet_wrap(~variables, ncol = 1, scales = "free") +
  scale_color_manual(values = color_values) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE, color=FALSE) +
  labs(color = "Model Runs") +
  coord_cartesian(xlim=c(2000, 2027))+
  ggtitle(scen, subtitle = "Management Term")+
  theme_bw()

t_plot_short + t_plot
  
}

all_term_plots<- map(unique(summary$ts$scenario), scen_ts_plots)

```

### default

```{r, warning=FALSE}
all_term_plots[[1]]
```

### 10 random red tides

```{r, warning=FALSE}
all_term_plots[[2]]
```

### 25 random red tides

```{r, warning=FALSE}
all_term_plots[[3]]
```

### Red tide every 3 years

```{r, warning=FALSE}
all_term_plots[[4]]
```

### Red tide every 5 years

```{r, warning=FALSE}
all_term_plots[[5]]
```

### Mortality = 0.5

```{r, warning=FALSE}
all_term_plots[[6]]
```
:::

Figure 21. Management Term plots are meant to be a "short term" (2000-2027) and "long term" (1989-2067) look at a few key parameters from the time series dataset.  These plots demonstrate that red tide events correspond with SPR Ratio spikes, and can slowly decrease retained biomass or spawning biomass in the short term.  In the long term, there are no trends.  I tried to add median trend lines for the OM and EM but they aren't very clear because of how the lines are colored.  




## Relative Error Plots

Inspired by Wetzel and Punt et al. 2011

I am going to attempt to make their Relative Error Plots.

RE = (E - T) / T

```{r}

OM_means <- summary$ts %>%
  filter(year >= 2017, model_run == paste0(OM_name, "_OM")) %>%
  select(year, Recruit_0, F_5, SpawnBio, iteration, retainB_1, retainB_2, retainB_4, deadB_5, F_1, F_2, F_4) %>%
  rowwise()%>%
  mutate(commercial = sum(retainB_1, retainB_2), recreational = retainB_4, com_f = sum(F_1, F_2), rec_f = F_4) %>%
  group_by(year) %>%
  reframe(OM_Recruit_0 = mean(Recruit_0), OM_F_5 = mean(F_5), OM_SpawnBio = mean(SpawnBio), OM_com = mean(commercial), OM_rec = mean(recreational), OM_dead_5 = mean(deadB_5), OM_com_f = mean(com_f), OM_rec_f = mean(rec_f))

EM_means <- summary$ts %>%
  filter(
    year >= 2017,
    str_detect(model_run, "_EM"),!str_detect(model_run, "init")
  ) %>%
  left_join(OM_means, by = c("year")) %>%
  rowwise()%>%
  mutate(commercial = sum(retainB_1, retainB_2), recreational = retainB_4, com_f = sum(F_1, F_2), rec_f = F_4) %>%
  group_by(scenario) %>%
  mutate(
    re_Recruit_0 = ifelse(
      is.na((Recruit_0 - OM_Recruit_0) / OM_Recruit_0),
      0,
      (Recruit_0 - OM_Recruit_0) / OM_Recruit_0
    ),
    #this put zeros back in.
    re_F_5 = ifelse(is.na((F_5 - OM_F_5) / OM_F_5), 0, (F_5 - OM_F_5) /
                      OM_F_5),
    re_SpawnBio = ifelse(is.na((SpawnBio - OM_SpawnBio) / OM_SpawnBio), 0, (SpawnBio - OM_SpawnBio) /
                      OM_SpawnBio),
        re_com = ifelse(is.na((commercial - OM_com) / OM_com), 0, (commercial - OM_com) /
                      OM_com),
        re_rec = ifelse(is.na((recreational - OM_rec) / OM_rec), 0, (recreational - OM_rec) /
                      OM_rec),
        re_dead_5 = ifelse(is.na((deadB_5 - OM_dead_5) / OM_dead_5), 0, (deadB_5 - OM_dead_5) /
                      OM_dead_5),
        re_com_f = ifelse(is.na((com_f - OM_com_f) / OM_com_f), 0, (com_f - OM_com_f) /
                      OM_com_f),
        re_rec_f = ifelse(is.na((rec_f - OM_rec_f) / OM_rec_f), 0, (rec_f - OM_rec_f) /
                      OM_rec_f),
    end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
    years_until_terminal = end_year - year
  )


```

::: panel-tabset
### Recruitment

```{r}
recruit <- EM_means %>% ggplot(aes(re_Recruit_0, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0)+
  theme_bw() + 
  ggtitle("Recruitment") + xlab("Relative error")
recruit
```

### SpawnBio

```{r}
spawn <- EM_means %>% 
  ggplot(aes(re_SpawnBio, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("SSB") + xlab("Relative error")
spawn
```

### Com F

```{r}

f_com<-EM_means %>% 
  ggplot(aes(re_com_f, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Commercial Mortality") + xlab("Relative error")
f_com
```

### Rec F

```{r}
f_rec <- EM_means %>% 
  ggplot(aes(re_rec_f, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Recreational Mortality") + xlab("Relative error")
f_rec
```

### F_5

```{r}
f5 <- EM_means %>% 
  filter(F_5 > 0) %>%
  ggplot(aes(re_F_5, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Red Tide Mortality (F_5)") + xlab("Relative error")
f5
```

### Com Catch

```{r}
com_c <- EM_means %>% 
  ggplot(aes(re_com, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Commercial Catch (Biomass)") + xlab("Relative error")
com_c
```

### Rec Catch

```{r}

rec_c <- EM_means %>% 
  ggplot(aes(re_rec, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Recreational Catch (Biomass)") + xlab("Relative error")
rec_c
```

### Red Tide Discards

```{r}

rt_c <-EM_means %>% 
  filter(F_5 > 0) %>%
  ggplot(aes(re_dead_5, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Red Tide Discards (Biomass)") + xlab("Relative error")
rt_c
```
:::

Figure 21. Relative error plots for each variable of interest zoomed in.  

```{r}
recruit <- recruit +
  theme(axis.text.y = element_blank()) 
f_rec <- f_rec +
  theme(axis.text.y = element_blank()) + ggtitle("Rec F")
f5 <- f5 +
  theme(axis.text.y = element_blank()) + ggtitle("F_5")
rec_c <- rec_c +
  theme(axis.text.y = element_blank()) + ggtitle("Rec catch")
rt_c <- rt_c +
  theme(axis.text.y = element_blank()) + ggtitle("RT catch")
spawn <- spawn 
f_com <- f_com  + ggtitle("Com F")
com_c <- com_c  + ggtitle("Com catch")

(spawn + recruit) / (f_com + f_rec + f5) / (com_c + rec_c + rt_c)

```

Figure 22. Relative error plots of each variable of interest on the same patchwork.   

```{r, warning = FALSE, message =FALSE}
recruit <- recruit +
  theme(axis.text.y = element_blank()) + xlim(-2,5)
f_rec <- f_rec +
  theme(axis.text.y = element_blank()) + xlim(-2,5)+ ggtitle("Rec F")
f5 <- f5 +
  theme(axis.text.y = element_blank()) + xlim(-2,5)+ ggtitle("F_5")
rec_c <- rec_c +
  theme(axis.text.y = element_blank()) + xlim(-2,5)+ ggtitle("Rec catch")
rt_c <- rt_c +
  theme(axis.text.y = element_blank()) + xlim(-2,5)+ ggtitle("RT catch")
spawn <- spawn + xlim(-2,5)
f_com <- f_com + xlim(-2,5) + ggtitle("Com F")
com_c <- com_c + xlim(-2,5) + ggtitle("Com catch")

(spawn + recruit) / (f_com + f_rec + f5) / (com_c + rec_c + rt_c)

```

Figure 23. Relative error plots of each variable of interest with fixed x-limits between -2 and 5.  

## Red Tide Magnitudes and Frequencies

The sums and counts of each red tide treatment to see which are comparable.  

```{r}

#calculate the "magnitude" of red tides

red_tide_magnitudes <- summary$ts %>% 
  filter(year >= 2017, 
         str_detect(model_run, "_EM"),
         !str_detect(model_run, "init")) %>%
  group_by(scenario) %>%
  reframe(F_5_sum = sum(F_5), 
          catch_sum = sum(deadB_5))

red_tide_years <- summary$ts %>% 
  filter(year >= 2017, 
         F_5 > 0,
         model_run == paste0(OM_name, "_OM"), 
         iteration == 1) %>% 
  group_by(scenario) %>%
  reframe(n_years = n_distinct(year)) %>%
  ungroup() %>%
  right_join(red_tide_magnitudes, join_by(scenario))

red_tide_years
```

Table 3. The magnitudes and frequencies of each scenario with the summarized catch to demonstrate scale differences.  

# Other Explorations

## Exploring Recruitment

::: panel-tabset
### Recruitment DQ

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.Recr, run_res_path = run_res_path)
```

### Recruitment TS

"rec_dev" "raw_rec_dev" "Recruit_0"

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, Recruit_0, run_res_path, save = TRUE)
```

### rec_dev TS

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, rec_dev, run_res_path, save = TRUE)
```

### raw rec_dev TS

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, raw_rec_dev, run_res_path, save = TRUE)
```
:::

## Selectivity Exploration


```{r}

library(r4ss)

# pull and plot a selectivity from every scenario
scen <- "red_tide_random_10"

size_sel_plots <- function(scen_list) {
  map_dfr(scen_list, function(scen) {
      map_dfr(1:10, function(iter) {
    selectivity_run <- file.path(cc_storage, paste0("results", results_name), scen, iter, paste0(OM_name, "_EM_2065"))

    selectivity_res <- SS_output(selectivity_run, printstats = FALSE, verbose = FALSE)

    selectivity_res$sizeselex %>%
      filter(Label == "2065_4_Lsel") %>%
      pivot_longer(
        cols = matches("^\\d+$"),
        names_to = "length",
        values_to = "selex"
      ) %>%
      mutate(scenario = scen, iteration = iter)
  })
  })
}

scen_dat <- size_sel_plots(scen_list)


om_scen_dat <- map_dfr(1:10, function(iter) {
    selectivity_run <- file.path(cc_storage, paste0("results", results_name), OM_name, iter, paste0(OM_name, "_EM_2065"))

    selectivity_res <- SS_output(selectivity_run, printstats = FALSE, verbose = FALSE)

    selectivity_res$sizeselex %>%
      filter(Label == "2065_4_Lsel") %>%
      pivot_longer(
        cols = matches("^\\d+$"),
        names_to = "length",
        values_to = "selex"
      ) %>%
      mutate(scenario = OM_name, iteration = iter)
  })

scen_dat <- rbind(scen_dat, om_scen_dat)

```

::: panel-tabset

### Selectivity at length (points)

```{r}
scen_dat %>%
  ggplot(aes(as.numeric(length), selex)) + 
  geom_point(aes(color = scenario, group = scenario)) +
  ggtitle("Length Selectivity")+
  theme_bw()
```

### Selectivity at length (lines)

```{r}
scen_dat %>%
  ggplot(aes(as.numeric(length), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario), size = 1, alpha = 3) +
  ggtitle("Length Selectivity")+
  theme_bw()
  
```

### Zoomed in Selectivity at length


```{r}
scen_dat <- scen_dat %>%
  mutate(is_highlighted = ifelse(scenario %in% c(OM_name), "Highlighted", "Other"))


scen_dat %>%
  ggplot(aes(as.numeric(length), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario), size = 1, alpha = 3) +
  ggtitle("Length Selectivity") +
  coord_cartesian(xlim = c(10, 25), ylim = c(0,0.4)) +
  theme_bw()
  
scen_dat %>%
  ggplot(aes(as.numeric(length), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario), size = 1, alpha = 3) +
  ggtitle("Length Selectivity")+
  coord_cartesian(xlim = c(30, 52))+
  theme_bw()

scen_dat %>%
  ggplot(aes(as.numeric(length), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario), size = 1, alpha = 3) +
  ggtitle("Length Selectivity")+
  coord_cartesian(xlim = c(50, 65))+
  theme_bw()

```

### Zoomed in Selectivity at length with highlighted line

```{r}

scen_dat %>%
  ggplot(aes(as.numeric(length), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario, size = is_highlighted), alpha = 3) +
  scale_size_manual(values = c("Highlighted" = 2.0, "Other" = 0.5)) +
  ggtitle("Length Selectivity") +
  coord_cartesian(xlim = c(10, 25)) +
  theme_bw()

scen_dat %>%
  ggplot(aes(as.numeric(length), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario, size = is_highlighted), alpha = 3) +
  scale_size_manual(values = c("Highlighted" = 2.0, "Other" = 0.5)) +  ggtitle("Length Selectivity")+
  coord_cartesian(xlim = c(25, 60))+
  theme_bw()

scen_dat %>%
  ggplot(aes(as.numeric(length), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario, size = is_highlighted), alpha = 3) +
  scale_size_manual(values = c("Highlighted" = 2.0, "Other" = 0.5)) +  ggtitle("Length Selectivity")+
  coord_cartesian(xlim = c(50, 65))+
  theme_bw()


```

:::


```{r}


# pull and plot a selectivity from every scenario

size_sel_plots <- function(scen_list) {
  map_dfr(scen_list, function(scen) {
      map_dfr(1:10, function(iter) {
    selectivity_run <- file.path(cc_storage, paste0("results", results_name), scen, iter, paste0(OM_name, "_EM_2065"))

    selectivity_res <- SS_output(selectivity_run, printstats = FALSE, verbose = FALSE)

    selectivity_res$ageselex %>%
      filter(Label == "2065_4_Asel2") %>% 
      pivot_longer(
        cols = matches("^\\d+$"),
        names_to = "age",
        values_to = "selex"
      ) %>%
      mutate(scenario = scen, iteration = iter)
  })
  })
}

scen_dat <- size_sel_plots(scen_list)


om_scen_dat <- map_dfr(1:10, function(iter) {
    selectivity_run <- file.path(cc_storage, paste0("results", results_name), OM_name, iter, paste0(OM_name, "_EM_2065"))

    selectivity_res <- SS_output(selectivity_run, printstats = FALSE, verbose = FALSE)

    selectivity_res$ageselex %>%
      filter(Label == "2065_4_Asel2") %>%
      pivot_longer(
        cols = matches("^\\d+$"),
        names_to = "age",
        values_to = "selex"
      ) %>%
      mutate(scenario = OM_name, iteration = iter)
  })

scen_dat <- rbind(scen_dat, om_scen_dat)

```

::: panel-tabset

### Selectivity at age (points)

```{r}
scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  geom_point(aes(color = scenario, group = scenario)) +
  ggtitle("age Selectivity")+
  theme_bw()
```

### Selectivity at age (lines)

```{r}
scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario), size = 1, alpha = 3) +
  ggtitle("age Selectivity")+
  theme_bw()
  
```

### Zoomed in Selectivity at age


```{r}
scen_dat <- scen_dat %>%
  mutate(is_highlighted = ifelse(scenario %in% c(OM_name), "Highlighted", "Other"))


scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario), size = 1, alpha = 3) +
  ggtitle("age Selectivity") +
  coord_cartesian(xlim = c(0, 5)) +
  theme_bw()
  
scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario), size = 1, alpha = 3) +
  ggtitle("age Selectivity")+
  coord_cartesian(xlim = c(5, 10))+
  theme_bw()

scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario), size = 1, alpha = 3) +
  ggtitle("age Selectivity")+
  coord_cartesian(xlim = c(10, 20))+
  theme_bw()

```

### Zoomed in Selectivity at age with highlighted line

```{r}

scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario, size = is_highlighted), alpha = 3) +
  scale_size_manual(values = c("Highlighted" = 2.0, "Other" = 0.5)) +
  ggtitle("age Selectivity") +
  coord_cartesian(xlim = c(0, 5)) +
  theme_bw()

scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario, size = is_highlighted), alpha = 3) +
  scale_size_manual(values = c("Highlighted" = 2.0, "Other" = 0.5)) +  ggtitle("age Selectivity")+
  coord_cartesian(xlim = c(5, 10))+
  theme_bw()

scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  stat_summary(fun = "median", geom = "line", aes(color = scenario, size = is_highlighted), alpha = 3) +
  scale_size_manual(values = c("Highlighted" = 2.0, "Other" = 0.5)) +  ggtitle("age Selectivity")+
  coord_cartesian(xlim = c(10, 20))+
  theme_bw()


```

:::

```{r}
age_sel_plots <- function(scen_list, iteration = 1, year = 2050) {
  map_dfr(scen_list, function(scen) {
    selectivity_run <- file.path(cc_storage, paste0("results", results_name), scen, iteration, paste0(OM_name, "_EM_", year))

    selectivity_res <- SS_output(selectivity_run, printstats = FALSE, verbose = FALSE)

    selectivity_res$ageselex %>%
      filter(Label == "2050_4_Asel2") %>%
      pivot_longer(
        cols = matches("^\\d+$"),
        names_to = "age",
        values_to = "selex"
      ) %>%
      mutate(scenario = scen)
  })
}

scen_dat <- age_sel_plots(scen_list)

scen_dat %>%
  ggplot(aes(as.numeric(age), selex)) + 
  geom_line(aes(color = scenario, group = scenario), linewidth = 1) +
  ggtitle("Age Selectivity")+
  theme_bw() 

```

## Ro Exploration

Extracted the R0 from SR_LN_R0 from the summary$scalar.  

```{r}

summary$scalar %>%
  select(iteration, scenario, model_run, SR_LN_R0) %>%
  mutate(r0 = exp(SR_LN_R0)) %>%
  ggplot(aes(scenario, r0)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

summary$scalar %>%
  select(iteration, scenario, model_run, SR_LN_R0) %>%
  mutate(r0 = exp(SR_LN_R0)) %>%
  ggplot(aes(scenario, r0)) +
  geom_boxplot(aes(color = model_run)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


```

```{r}

ratio_R0 <- summary$scalar %>%
  select(iteration, scenario, model_run, SR_LN_R0) %>%
  mutate(r0 = exp(SR_LN_R0)) %>%
  select(!SR_LN_R0) %>%
  filter(model_run %in% c(paste0(OM_name, "_OM"), paste0(OM_name, "_EM_2065"))) %>%
  pivot_wider(
      names_from = model_run,  # this will create "OM" and "EM" columns
      values_from = r0
  ) %>%
  rename("OM" = paste0(OM_name, "_OM") , "EM" = paste0(OM_name, "_EM_2065")) %>%
  group_by(scenario, iteration) %>%
  mutate(ratio_R0 = EM/OM)
  
ratio_R0 %>%
  ggplot(aes(scenario, ratio_R0)) +
  geom_boxplot()

```


# Old versions

## Red tide years, biomass ratio, just Com and Rec Retained and Discards

This is the biomass ratios in just the red tide years so the trends are more clear in Fleet 5.

```{r}

plot_fleet_terminal_ratio <- function(scen) {
  
  OM_mean <- summary$ts %>% 
    filter(year >= 2017, 
         scenario == scen, 
         model_run == paste0(OM_name, "_OM")) %>%
    pivot_longer(c(retainB_1, retainB_2, retainB_3, retainB_4, deadB_5, deadB_1, deadB_2, deadB_4), names_to = "fleet", values_to = "OM_value") %>%
    select(fleet, year, OM_value, iteration) %>%
    group_by(fleet,year) %>% 
    reframe(OM_value = mean(OM_value))

# In these cases, OM_mean is always going to be 0.2 or 0.5 because that is the designated expected F_5 for every red tide event
  
red_tide_years <- summary$ts %>% 
  filter(year >= 2017, 
         F_5 > 0,
         scenario == scen, 
         model_run == paste0(OM_name, "_OM"), 
         iteration == 1) %>% 
          pull(year)

red_tide_means <- summary$ts %>% 
  filter(year >= 2017, 
         scenario == scen, 
         year %in% red_tide_years,
         str_detect(model_run, "_EM"),
         !str_detect(model_run, "init")) %>%
  pivot_longer(c(retainB_1, retainB_2, retainB_4,  deadB_1, deadB_2, deadB_4), names_to = "fleet") %>%
  left_join(OM_mean, by = c("fleet", "year")) %>%
  mutate(ratio_F = ifelse(is.na(value/OM_value), 0, value/OM_value), #this put zeros back in.  
         end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
         years_until_terminal = end_year - year)

rt_summary <- red_tide_means %>%
  group_by(fleet, years_until_terminal) %>%
  reframe(
    mean_ratio = mean(ratio_F, na.rm = TRUE),
    sd_ratio = sd(ratio_F, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    ymin = mean_ratio - sd_ratio,
    ymax = mean_ratio + sd_ratio
  )

rt_terminal_ratio <- red_tide_means %>%
  ggplot() +
  geom_point(aes(years_until_terminal, ratio_F), color = "grey") +
  geom_ribbon(data = rt_summary, aes(x = years_until_terminal, ymin = ymin, ymax = ymax),     # Ribbon for 1 SD
              fill = "lightblue", alpha = 0.8) +
  geom_line(data = rt_summary, aes(x = years_until_terminal, y = mean_ratio),   # Mean line
            linewidth = .7, color = "black") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  xlim(0,50) +
  ggtitle(scen) +
  ylab("Ratio of Biomass (EM:OM)") + xlab("Years until terminal") + 
  facet_wrap(~fleet) + 
  theme_bw()

rt_terminal_ratio
  
}

fishing_terminal_plots <- map(scen_list, plot_fleet_terminal_ratio)

```


::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
fishing_terminal_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
fishing_terminal_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
fishing_terminal_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
fishing_terminal_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
fishing_terminal_plots[[5]]
```
:::

## F-Ratios over time, All years

```{r}

plot_fleet_terminal_ratio <- function(scen) {
  
  OM_mean <- summary$ts %>% 
    filter(year >= 2017, 
         scenario == scen, 
         model_run == paste0(OM_name, "_OM")) %>%
    pivot_longer(c(F_1, F_2, F_3, F_4, F_5), names_to = "fleet", values_to = "OM_value") %>%
    select(fleet, year, OM_value, iteration) %>%
    group_by(fleet,year) %>% 
    reframe(OM_value = mean(OM_value))

# In these cases, OM_mean is always going to be 0.2 or 0.5 because that is the designated expected F_5 for every red tide event

red_tide_means <- summary$ts %>% 
  filter(year >= 2017, 
         scenario == scen, 
         str_detect(model_run, "_EM"),
         !str_detect(model_run, "init")) %>%
  pivot_longer(c(F_1, F_2, F_3, F_4, F_5), names_to = "fleet") %>%
  left_join(OM_mean, by = c("fleet", "year")) %>%
  mutate(ratio_F = value/OM_value)

rt_summary <- red_tide_means %>%
  group_by(year, fleet) %>%
  reframe(
    mean_ratio = mean(ratio_F, na.rm = TRUE),
    sd_ratio = sd(ratio_F, na.rm = TRUE),
  ) %>%
  mutate(
    ymin = mean_ratio - sd_ratio,
    ymax = mean_ratio + sd_ratio
  )%>%
  filter(!is.na(mean_ratio))

rt_terminal_ratio <- red_tide_means %>%
  ggplot() +
  geom_point(aes(year, ratio_F), color = "grey") +
  geom_ribbon(data = rt_summary, aes(x = year, ymin = ymin, ymax = ymax),     # Ribbon for 1 SD
              fill = "lightblue", alpha = 0.8) +
  geom_line(data = rt_summary, aes(x = year, y = mean_ratio),   # Mean line
            linewidth = .7, color = "black") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  ggtitle(scen) +
  ylab("Ratio of F (EM:OM)") + xlab("Years until terminal") + 
  facet_wrap(~fleet) + 
  theme_bw()

rt_terminal_ratio
  
}

fishing_terminal_plots <- map(scen_list, plot_fleet_terminal_ratio)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
fishing_terminal_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
fishing_terminal_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
fishing_terminal_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
fishing_terminal_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
fishing_terminal_plots[[5]]
```
:::


## F/Fmsy Ratio

```{r}

plot_fleet_terminal_ratio <- function(scen) {
  
  OM_mean <- summary$ts %>% 
    filter(year >= 2017, 
         scenario == scen, 
         model_run == paste0(OM_name, "_OM")) %>%
    pivot_longer(c(F_1, F_2, F_3, F_4, F_5), names_to = "fleet", values_to = "OM_value") %>%
    select(fleet, year, OM_value, iteration) %>%
    group_by(fleet,year) %>% 
    reframe(OM_value = mean(OM_value))
  
  f_msy_OM <- 0.259
  
  f_msy_EM <- summary$scalar %>%
    filter(scenario == scen, 
           str_detect(model_run, "_EM"),
           !str_detect(model_run, "init")) %>%
    group_by(model_run) %>%
    reframe(mean_Fmsy = mean(F_MSY)) 

# In these cases, OM_mean is always going to be 0.2 or 0.5 because that is the designated expected F_5 for every red tide event

red_tide_means <- summary$ts %>% 
  filter(year >= 2017, 
         scenario == scen, 
         str_detect(model_run, "_EM"),
         !str_detect(model_run, "init")) %>%
  pivot_longer(c(F_1, F_2, F_3, F_4, F_5), names_to = "fleet") %>%
  left_join(OM_mean, by = c("fleet", "year")) %>%
  left_join(f_msy_EM, by = "model_run") %>%
  mutate(ratio_F = (value/mean_Fmsy)/(OM_value/f_msy_OM), 
         end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
         years_until_terminal = end_year - year)

rt_summary <- red_tide_means %>%
  filter(years_until_terminal > 0) %>%
  group_by(fleet, years_until_terminal) %>%
  reframe(
    median_ratio = median(ratio_F, na.rm = TRUE),
    sd_ratio = sd(ratio_F, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    ymin = median_ratio - sd_ratio,
    ymax = median_ratio + sd_ratio
  )

rt_terminal_ratio <- red_tide_means %>%
  filter(years_until_terminal > 0) %>%
  ggplot(aes(years_until_terminal, ratio_F)) +
  geom_point(color = "grey") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_line(data = rt_summary, aes(years_until_terminal, median_ratio)) +
  scale_color_nmfs(palette = "oceans", reverse = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  ggtitle(scen) +
  ylab("Ratio of F/Fmsy (EM:OM)") + xlab("Years until terminal") + 
  facet_wrap(~fleet) + 
  theme_bw()

rt_terminal_ratio
  
}

fishing_terminal_plots <- map(scen_list, plot_fleet_terminal_ratio)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
fishing_terminal_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
fishing_terminal_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
fishing_terminal_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
fishing_terminal_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
fishing_terminal_plots[[5]]
```
:::

# Time Series

## Fishing mortalities

```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- EM_runs %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1, F_2, F_3, F_4, F_5),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    ggplot() +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year, color = fleet),
      linewidth = 1
    ) +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("F") + xlab("Years") +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
f_ts_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
f_ts_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
f_ts_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
f_ts_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
f_ts_plots[[5]]
```

:::

Figure . F over time by scenario.  The line indicates the median for each fleet.  When a red tide event happens there is a simultaneous drop in F especially in fleet 4 and a increase in F_4 in the next year.  F_1 and F_2 follow a similar but less extreme pattern.  

## Biomass

```{r}

plot_biomass_ts <- function(scen) {
  
  fleet_ratios <- EM_runs %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(retainB_1, retainB_2, retainB_3, retainB_4, deadB_5),
                 names_to = "fleet",
                 values_to = "ratio_Biomass") %>%
    mutate(fleet = str_sub(fleet, start = 9, end = 9)) %>%
    select(fleet, year, ratio_Biomass, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year,
      fleet = if_else(fleet == "", "5", fleet)
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_Biomass, na.rm = TRUE),
      lower_quartile = quantile(ratio_Biomass, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_Biomass, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    ggplot() +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year, color = fleet),
      linewidth = 1
    ) +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Biomass") + xlab("Years") +
    theme_bw()
  
  rt_terminal_ratio
  
}

biomass_ts_plots <- map(scen_list, plot_biomass_ts)

```

::: panel-tabset
### 10 random red tides

```{r, warning=FALSE}
biomass_ts_plots[[1]]
```

### 25 random red tides

```{r, warning=FALSE}
biomass_ts_plots[[2]]
```

### Red tide every 3 years

```{r, warning=FALSE}
biomass_ts_plots[[3]]
```

### Red tide every 5 years

```{r, warning=FALSE}
biomass_ts_plots[[4]]
```

### Mortality = 0.5

```{r, warning=FALSE}
biomass_ts_plots[[5]]
```
:::

Figure . Biomass over time by scenario.  The line indicates the median for each fleet.  When a red tide event happens there is a simultaneous drop in retained biomass and a increase in retained biomass in the next year.  


## Recruitment

```{r, warning=FALSE}
  
  fleet_ratios <- EM_runs %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, Recruit_0, iteration, model_run, scenario) %>%
    rename(ratio_recruitment = Recruit_0) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year
    )
  
  red_tide_years <- summary$ts %>%
    filter(
      year >= 2017,
      F_5 > 0,
      model_run == paste0(OM_name, "_OM"),
      iteration == 1
    ) %>%
    select(scenario, year)

  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_recruitment, na.rm = TRUE),
      lower_quartile = quantile(ratio_recruitment, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_recruitment, 0.75, na.rm = TRUE)
    ) 
  
  recruitment_ratio_plot <- fleet_ratios %>%
    ggplot() +
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
  geom_vline(
    data = red_tide_years, 
    aes(xintercept = year), 
    color = "grey",          
    linetype = "dashed"     
  ) +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("Recruitment") +
    ylab("Recruitment") + xlab("Years") +
    facet_wrap(~scenario) +
    theme_bw()
  
  recruitment_ratio_plot

```

Figure 13. Recruitment ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  Recruitment is not over or underestimated, but there are a few outliers where the EM overestimated by 10x.   

## SSB

```{r, warning=FALSE}
  
  fleet_ratios <- EM_runs %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, SpawnBio, iteration, model_run, scenario) %>%
    rename(ratio_recruitment = SpawnBio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$")),
      years_until_terminal = end_year - year
    )
  
  red_tide_years <- summary$ts %>%
    filter(
      year >= 2017,
      F_5 > 0,
      model_run == paste0(OM_name, "_OM"),
      iteration == 1
    ) %>%
    select(scenario, year)

  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_recruitment, na.rm = TRUE),
      lower_quartile = quantile(ratio_recruitment, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_recruitment, 0.75, na.rm = TRUE)
    ) 
  
  recruitment_ratio_plot <- fleet_ratios %>%
    ggplot() +
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
  geom_vline(
    data = red_tide_years, 
    aes(xintercept = year), 
    color = "grey",          
    linetype = "dashed"     
  ) +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("SSB") +
    ylab("SSB") + xlab("Years") +
    facet_wrap(~scenario) +
    theme_bw()
  
  recruitment_ratio_plot

```
