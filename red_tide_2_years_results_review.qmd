---
format:
  html:
    toc: true
    toc_location: right
    embed-resources: true
editor: source
execute:
  echo: false
---

```{r, include = FALSE}
library(tidyverse)
library("nmfspalette")
library(patchwork)
library(knitr)
library(kableExtra)

#name of the OM
OM_name <- "default"
run_SSMSE_dir <- file.path("C:/Users/apn26/Documents/CIMAS/Personal Notes/test_cloud_computing/testing_cloud")
default <- file.path(run_SSMSE_dir, OM_name)

#name of the results files
results_name <- "_rt_2_fixed_2021"

#pull the summary and dat files, the dat file isn't actually that important.  
cc_storage <- file.path("C:/Users/apn26/Documents/CIMAS/Personal Notes/cc_storage")
summary <- readRDS(file = file.path(cc_storage, paste0("results_summary", results_name, ".rda")))
dat <- r4ss::SS_readdat(file.path(default, "red_grouper_1986_2017_RedTideFleet.dat"))


summary$ts <- summary$ts %>%
  filter(model_run != "", !str_detect(model_run, "Base")) %>% #remove "Base" model 
  mutate(end_year = as.numeric(str_extract(model_run, "\\d{4}$")) + 3, 
         years_until_terminal = end_year - year) %>%
  filter(case_when(
    str_detect(model_run, "_EM") ~ years_until_terminal > 2,
    TRUE ~ TRUE # Keep all other rows if no _EM
  )) %>%
  mutate(
    scenario = factor(scenario, 
                      levels = c("no_rt", 
                                 "no_rt_x_rt_2", 
                                 "rt_2_x_no_rt", 
                                 "rt_2_x_rt_2", "rt_2_x_rt_2_fixed",
                                 "no_rt_x_all_yrs", 
                                 "rt_2_x_all_yrs",
                                 "rep_3_x_all_yrs"))
  )

summary$dq <- summary$dq %>%
  filter(model_run != "", !str_detect(model_run, "Base")) %>%
  mutate(end_year = as.numeric(str_extract(model_run, "\\d{4}$")) + 3,
         years_until_terminal = end_year - year) %>%
  filter(case_when(
    str_detect(model_run, "_EM") ~ years_until_terminal > 2,
    TRUE ~ TRUE # Keep all other rows if no _EM
  )) %>%
  mutate(
    scenario = factor(scenario, 
                      levels = c("no_rt", 
                                 "no_rt_x_rt_2", 
                                 "rt_2_x_no_rt", 
                                 "rt_2_x_rt_2", "rt_2_x_rt_2_fixed",
                                 "no_rt_x_all_yrs", 
                                 "rt_2_x_all_yrs",
                                 "rep_3_x_all_yrs"))
  )
summary$scalar <- summary$scalar %>%
  filter(model_run != "", !str_detect(model_run, "Base")) 

#rename the OM if it's different from default
OM_name <- "default_sigmaR"

```

```{r}
#create a list of scenarios for plot generation, usually the default order is fine.  
#scen_list <- unique(summary$ts$scenario)
#hard coded in a specific order.  
scen_list <- c("no_rt", "no_rt_x_rt_2", "rt_2_x_no_rt", "rt_2_x_rt_2", "rt_2_x_rt_2_fixed", "no_rt_x_all_yrs", 
                                 "rt_2_x_all_yrs",
                                 "rep_3_x_all_yrs")

```

## Comparing Future Red Tide Scenarios

These outputs are generated from the results_`{r} results_name` file. I took the SEDAR Red Grouper stock assessment and used SSMSE to introduce future red tide events in the OM and EM. There were 8 total scenarios:

1.  No red tide X no red tide: the base stock assessment with red tide events in 2005 and 2014.\
2.  No red tide X 2 red tide: red tide in 2018 and 2021 in the EM.\
3.  2 red tide X no red tide: red tide in 2018 and 2021 in the OM, but not in the EM.\
4.  2 red tide X 2 red tide: red tide in 2018 and 2021 in the OM and EM, EM estimated.\
5.  2 red tide X 2 red tide fixed: red tide in 2018 and 2021 in the OM and EM, EM fixed.\
6.  No red tide X all years red tide: no red tide in OM, all years red tide in EM.\
7.  2 red tide X all years red tide: red tide in 2018 and 2021 in OM, all years red tide in EM.\
8.  red tide every 3 years X all years red tide: red tide every 3 years in OM starting in 2018, all years red tide in EM.

Import the results and summary files from the cloud.

# Raw Data

## Reviewing time series plots

List of the things we can plot with the ts_plot_variable function:

```{r, echo = FALSE}

ts_plot_variable <- function(summary, variable = SpawnBio, run_res_path, save = TRUE) {
  
  # identify the last year sampled by SSMSE
  max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
    summary$ts$model_run %>% 
      unique() %>% # get the list of unique model runs
      str_sub(-4) %>% # select last 4 characters of EM names
      {
        ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
      } %>% # check the last 4 characters are numbers or make NA
      max(na.rm = TRUE) # find the max EM year
  )
  
  # make a list that includes the OM and all max_sample_year EMs  
  key_models <- unique(summary$ts$model_run)
  key_models <- key_models[grepl("OM", key_models) | grepl(as.character(max_sample_year), key_models)]
  
  # set the OM to bright orange, and all the other models to black
  color_values <- setNames(
    ifelse(grepl("OM", key_models), "#D65F00", "black"),
    key_models
  )
  
  var_name <- rlang::as_name(enquo(variable))
  title <- (paste(var_name,"timeseries by scenario"))
  
  ssb_ts_plot <- summary$ts %>% 
    filter(model_run %in% key_models) %>% #filters to just OM and max year runs
     ggplot(aes(x = year, y = {{ variable }})) +
     geom_vline(xintercept = dat$endyr, color = "gray") +
     geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
     geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
     geom_line( aes(linetype = as.character(iteration), color = model_run))+
     scale_color_manual(values = color_values) +
     scale_linetype_manual(values = rep("solid", 100)) +
     guides(linetype = FALSE) +
     labs(color = "Model Runs") +
     ggtitle(title) +
     facet_wrap(~scenario, labeller = labeller(scenario = function(x) gsub("_", " ", x))) +
     theme_bw()
  
  
  if(save == TRUE){
    ggsave(file.path(run_res_path, "plots", paste0(gsub(" ", "_", title), ".png")),
           width = 8, height = 6, units = "in", device = "png")
  }
  
  return(ssb_ts_plot)
  
}

colnames(summary$ts)

```

Here are the time series plots:

::: panel-tabset
### Red tide mortality

```{r, echo = FALSE, warning = FALSE}
run_res_path <- file.path(run_SSMSE_dir, "results")

ts_plot_variable(summary, F_5, run_res_path, save = TRUE)
```

Figure 1. The fishing mortality of fleet 5 over time.  This line plot demonstrates the frequency and magnitude of red tide events in the EM (black) and OM (orange) for each scenario. All 10 iterations of the OM and EM are plotted simultaneously so peaks are representative of the iteration with the highest value and not the overall trend.  The OMs have fixed magnitudes and the EMs estimate a F_5 that varies in magnitude but has a median close to the fixed value in the OM.  


```{r, echo = FALSE, warning = FALSE}

  max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
    summary$ts$model_run %>% 
      unique() %>% # get the list of unique model runs
      str_sub(-4) %>% # select last 4 characters of EM names
      {
        ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
      } %>% # check the last 4 characters are numbers or make NA
      max(na.rm = TRUE) # find the max EM year
  )
  
  # make a list that includes the OM and all max_sample_year EMs  
  key_models <- unique(summary$ts$model_run)
  key_models <- key_models[grepl("OM", key_models) | grepl(as.character(max_sample_year), key_models)]
  

F_5_summary <- summary$ts %>%
  filter(model_run %in% key_models, F_5 > 0, year > 2017) %>% #this might exclude 0's when there is supposed to be a red tide.  
  group_by(model_run, scenario) %>%
  reframe(mean_F_5 = round(mean(F_5), 3),
          sd_F_5 = round(sd(F_5), 3),
          median_F_5 = round(median(F_5),3))

```

Table 1. A summary of the Operating Model fleet 5 fishing mortality. These statistics only include values where F_5 > 0 and years > 2017.   

```{r, echo = FALSE, warning = FALSE}
F_5_summary %>%
  filter(str_detect(model_run, "OM")) %>%
  select(!model_run) %>%
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Mean", "Standard Dev", "Median"),
    align = c("l", "c", "c", "c") # Align columns (left, center, center, center)
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )
```


Table 2. A summary of the Estimated Model fleet 5 fishing mortality. These statistics only include values where F_5 > 0 and years > 2017.   

```{r, echo = FALSE, warning = FALSE}
F_5_summary %>%
  filter(str_detect(model_run, "EM")) %>%
  select(!model_run) %>%
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Mean", "Standard Dev", "Median"),
    align = c("l", "c", "c", "c") # Align columns (left, center, center, center)
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )
```

### Red tide dead biomass

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, deadB_5, run_res_path, save = TRUE)
```

Figure 2. The biomass of fish killed by red tide over time.  This line plot demonstrates the biomass removed by red tide.  While fishing mortality is fixed in the OM, the biomass removed can vary depending on the available biomass.  

### Spawning Stock Biomass

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, SpawnBio, run_res_path, save = TRUE)
```

Figure 3. The spawning stock biomass (SSB) over time.  These plots best demonstrate the effects of the red tide mortality on the spawning availability, with the increased frequency and magnitude of red tides resulting in lower SSB.  

### Retained Biomass

```{r, echo = FALSE, warning = FALSE}

# model run selection: include OM, max year runs
model_names <- tibble(names = unique(summary$ts$model_run))

# select only the max year runs
last_year_models <- model_names %>%
  mutate(
    numbers = str_extract_all(names, "\\d+"), # Extract all numbers as a list of characters
    max_number = sapply(numbers, function(x) max(as.numeric(x))) # Find the max number in each list
  ) %>%  
  filter(max_number == max(max_number, na.rm = TRUE)) %>%
  select(names)

ssb_ts_plot <- summary$ts %>% 
  filter(str_detect(model_run, "OM")|model_run %in% last_year_models$names) %>% #filters to just OM and max year runs
  mutate(retainB_all = select(., starts_with("retainB")) %>% rowSums()) %>%
  ggplot(aes(x = year, y = retainB_all)) +
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
  scale_color_manual(values = c("#D65F00", "black",'blue','green')) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE) +
  labs(color = "Model Runs") +
  facet_wrap(. ~ scenario, ncol=2, nrow=4) +
  ggtitle("All retained biomass overtime") +
  theme_bw()
ssb_ts_plot

```

Figure 4. The total retained biomass of the fishery over time.  This is the sum of all columns starting with "RetainB" so it does not include discards or red tide mortality.  This plot demonstrates how impactful high mortality events can reduce catch.  

:::

::: panel-tabset

### F_1
```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, F_1, run_res_path, save = TRUE)
```


### F_2
```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, F_2, run_res_path, save = TRUE)
```

### F_4

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, F_4, run_res_path, save = TRUE)
```

:::

## Reviewing derived quantities

Additional time series plots but derived quantities. Below is a list of all the derived quantity variables:

```{r, echo = FALSE, warning = FALSE}

dq_plot_variable <- function(summary, variable = Value.SSB, run_res_path, save = TRUE) {
  
  # identify the last year sampled by SSMSE
  max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
    summary$dq$model_run %>% 
      unique() %>% # get the list of unique model runs
      str_sub(-4) %>% # select last 4 characters of EM names
      {
        ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
      } %>% # check the last 4 characters are numbers or make NA
      max(na.rm = TRUE) # find the max EM year
  )
  
  # make a list that includes the OM and all max_sample_year EMs  
  key_models <- unique(summary$dq$model_run)
  key_models <- key_models[grepl("OM", key_models) | grepl(as.character(max_sample_year), key_models)]
  
  # set the OM to bright orange, and all the other models to black
  color_values <- setNames(
    ifelse(grepl("OM", key_models), "#D65F00", "black"),
    key_models
  )
  
  var_name <- rlang::as_name(enquo(variable))
  title <- (paste(var_name,"timeseries by scenario"))
  
  ssb_dq_plot <- summary$dq %>% 
    filter(model_run %in% key_models) %>% #filters to just OM and max year runs
     ggplot(aes(x = year, y = {{ variable }})) +
     geom_vline(xintercept = dat$endyr, color = "gray") +
     geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
     geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
     geom_line( aes(linetype = as.character(iteration), color = model_run))+
     scale_color_manual(values = color_values) +
     scale_linetype_manual(values = rep("solid", 100)) +
     guides(linetype = FALSE) +
     labs(color = "Model Runs") +
     ggtitle(title) +
     facet_wrap(~scenario, labeller = labeller(scenario = function(x) gsub("_", " ", x))) +
     theme_bw()
  
  
  if(save == TRUE){
    ggsave(file.path(run_res_path, "plots", paste0(gsub(" ", "_", title), ".png")),
           width = 8, height = 6, units = "in", device = "png")
  }
  
  return(ssb_dq_plot)
  
}

colnames(summary$dq)


```

::: panel-tabset
### Recruitment

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.Recr, run_res_path = run_res_path)
```

Figure 5. Recruitment over time by scenario.  Recruitment is determined by the Beverton-Holt equation using steepness, R0, and SigmaR.  Steepness is fixed at 0.99.  R0 and SigmaR were estimated in SEDAR 61 and SEDAR 88.  

### SSB

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, run_res_path = run_res_path)
```

Figure 6 (same as figure 3). The spawning stock biomass (SSB) over time.  These plots best demonstrate the effects of the red tide mortality on the spawning availability, with the increased frequency and magnitude of red tides resulting in lower SSB.  

### SPR Ratio

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.SPRratio, run_res_path = run_res_path)
```

Figure 7. The Spawning Potential Ratio (SPR) over time by scenario.  This is the spawning output with fishing:the spawning output without fishing so it is a higher value when the reproductive potential is high.  SPR tends to spike when there is a red tide event.  

### B Ratio

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.Bratio, run_res_path = run_res_path)
```

Figure 8. The BRatio over time by scenario.  The BRatio is the current SSB over the unfished SSB so the value indicates the status of the SSB relative to a unfished scenario.  This can be usefull if there is a reference point for BRatio like 0.2 as a cut-off for overfished.  Higher frequencies and magnitudes of red tide cause a BRatio less than 0.2 more often.  

### F

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.F, run_res_path = run_res_path)
```

Figure 9. The total fishing mortality over time by scenario.  The default scenario indicates that fishing over time has low variability.  When Red tide events are introduced,  the variability increases drastically as F includes red tide mortality.  Since red tide is a by-catch fleet, it is included in this value.

:::

# Summarized Time Series

```{r}
#set up the OM and EM dataframes, join them, and calculate the EM:OM ratio for each available value

OM_runs <- summary$ts %>%
  filter(str_detect(model_run, "OM"))
  
EM_runs <- summary$ts %>%
  filter(str_detect(model_run, "EM"))

OM_runs_dq <- summary$dq %>%
  filter(str_detect(model_run, "OM"))
  
EM_runs_dq <- summary$dq %>%
  filter(str_detect(model_run, "EM"))

```

### Stat of variables over time plots

```{r}
# prepare data for stat of variable over time plots

# create a data frame of OM means, medians, and sds by year and scenario
OM_lines <- OM_runs %>%
  group_by(year, scenario) %>%
  summarise(
    across(
      .cols = where(is.numeric), # Selects all numeric columns
      .fns = list(
        mean = ~ mean(.x, na.rm = TRUE), # Mean function
        median = ~ median(.x, na.rm = TRUE), # Median function
        sd = ~ sd(.x, na.rm = TRUE) # Standard Deviation function
      ),
      # Names the new columns (e.g., value1_mean, value1_median, value1_sd)
      .names = "{.col}_{.fn}" 
    ),
    .groups = "drop" # Drops the grouping structure
  ) %>% mutate(model_type = "OM")

# create a data frame of EM means, medians, and sds by year and scenario
# this currently uses all model_runs, should it just be the last model_run?  
EM_lines <- EM_runs %>%
  group_by(year, scenario) %>%
  summarise(
    across(
      .cols = where(is.numeric), # Selects all numeric columns
      .fns = list(
        mean = ~ mean(.x, na.rm = TRUE), # Mean function
        median = ~ median(.x, na.rm = TRUE), # Median function
        sd = ~ sd(.x, na.rm = TRUE) # Standard Deviation function
      ),
      # Names the new columns (e.g., value1_mean, value1_median, value1_sd)
      .names = "{.col}_{.fn}" 
    ),
    .groups = "drop" # Drops the grouping structure
  ) %>% mutate(model_type = "EM")

combined_lines <- rbind(OM_lines, EM_lines)

# Set the factor level order so EM drawn last (on top of plot)
combined_lines$model_type <- factor(
  combined_lines$model_type, 
  levels = c("OM", "EM") 
)
```

``` {r}
# plot variable function

plot_variable_ts <- function(variable = "deadB_5", stat_type = "median", years = c(2004,2025)){
  y_var_sym = sym(paste0(variable, "_", stat_type))

ggplot(combined_lines, aes(x = year, y = !!y_var_sym, color = model_type)) +
  geom_line(aes(linetype = model_type)) +
  facet_wrap(~scenario) +
  ggtitle(paste(stat_type, variable, "over time")) +
  scale_color_manual(
    name = "Model",
    values = c("OM" = "#D65F00", "EM" = "black"), 
    labels = c("OM" = "OM", "EM" = "EM"),
    breaks = c("OM", "EM") 
  ) +
  scale_linetype_manual(
    name = "Model", 
    values = c("OM" = "solid", "EM" = "dashed"),
    labels = c("OM" = "OM", "EM" = "EM"),
    breaks = c("OM", "EM") 
  ) + 
  coord_cartesian(xlim = years)
}

plot_list <- list(
plot_variable_ts(),
plot_variable_ts(variable = "SpawnBio", stat_type = "median"),
plot_variable_ts(variable = "Bio_smry", stat_type = "median"),
plot_variable_ts(variable = "F_1", stat_type = "median"),
plot_variable_ts(variable = "F_2", stat_type = "median"),
plot_variable_ts(variable = "F_4", stat_type = "median"),
plot_variable_ts(variable = "F_5", stat_type = "median")
)

```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each table
for (q in 1:length(plot_list)) {
  # 1. Print the tab name (required for this method)
  cat('###', plot_list[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(plot_list[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```
:::


### dq of variables over time plots

```{r}
# prepare data for stat of variable over time plots

# create a data frame of OM means, medians, and sds by year and scenario
OM_lines_dq <- OM_runs_dq %>%
  group_by(year, scenario) %>%
  summarise(
    across(
      .cols = where(is.numeric), # Selects all numeric columns
      .fns = list(
        mean = ~ mean(.x, na.rm = TRUE), # Mean function
        median = ~ median(.x, na.rm = TRUE), # Median function
        sd = ~ sd(.x, na.rm = TRUE) # Standard Deviation function
      ),
      # Names the new columns (e.g., value1_mean, value1_median, value1_sd)
      .names = "{.col}_{.fn}" 
    ),
    .groups = "drop" # Drops the grouping structure
  ) %>% mutate(model_type = "OM")

# create a data frame of EM means, medians, and sds by year and scenario
# this currently uses all model_runs, should it just be the last model_run?  
EM_lines_dq <- EM_runs_dq %>%
  group_by(year, scenario) %>%
  summarise(
    across(
      .cols = where(is.numeric), # Selects all numeric columns
      .fns = list(
        mean = ~ mean(.x, na.rm = TRUE), # Mean function
        median = ~ median(.x, na.rm = TRUE), # Median function
        sd = ~ sd(.x, na.rm = TRUE) # Standard Deviation function
      ),
      # Names the new columns (e.g., value1_mean, value1_median, value1_sd)
      .names = "{.col}_{.fn}" 
    ),
    .groups = "drop" # Drops the grouping structure
  ) %>% mutate(model_type = "EM")

combined_lines_dq <- rbind(OM_lines_dq, EM_lines_dq)

# Set the factor level order so EM drawn last (on top of plot)
combined_lines_dq$model_type <- factor(
  combined_lines_dq$model_type, 
  levels = c("OM", "EM") 
)
```

``` {r}
# plot variable function

plot_variable_dq <- function(variable = "deadB_5", stat_type = "median", years = c(2004,2025)){
  y_var_sym = sym(paste0(variable, "_", stat_type))

ggplot(combined_lines_dq, aes(x = year, y = !!y_var_sym, color = model_type)) +
  geom_line(aes(linetype = model_type)) +
  facet_wrap(~scenario) +
  ggtitle(paste(stat_type, variable, "over time")) +
  scale_color_manual(
    name = "Model",
    values = c("OM" = "#D65F00", "EM" = "black"), 
    labels = c("OM" = "OM", "EM" = "EM"),
    breaks = c("OM", "EM") 
  ) +
  scale_linetype_manual(
    name = "Model", 
    values = c("OM" = "solid", "EM" = "dashed"),
    labels = c("OM" = "OM", "EM" = "EM"),
    breaks = c("OM", "EM") 
  ) + 
  coord_cartesian(xlim = years)
}

plot_list <- list(
plot_variable_dq(variable = "Value.SSB", stat_type = "median"),
plot_variable_dq(variable = "Value.Recr", stat_type = "median"),
plot_variable_dq(variable = "Value.F", stat_type = "median"),
plot_variable_dq(variable = "Value.Bratio", stat_type = "median")
)
```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each table
for (q in 1:length(plot_list)) {
  # 1. Print the tab name (required for this method)
  cat('###', plot_list[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(plot_list[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```
:::


# Ratio Time Series

WARNING: EM:OM ratios do not work will with zeros in some fishing mortalities.  If the EM and OM are both zero, the ratio is forced to 1.  However, when the OM or EM is zero the result is either zero or na which has resulted in misleading F_5 plots.  I changed the OM value to 0.001 to eliminate the Inf but it results in large ratios that expand the y-axis scale.We recommend the F.Value from dq plots to discuss overall changes in F across all fleets.  

## Fishing mortalities

My new method for plotting EM:OM involves creating separate OM and EM data frames, joining them by year, scenario, and iteration, then dividing the EM value/ OM value for every variable.  That way when plotted it is truly the EM for each model run, year and iteration divided by the OM from the same year and iteration but one model run.  If the om and em value are zero I changed the ratio to 1 because that means that the EM = OM.  

```{r}

ratio_df <- left_join(EM_runs, OM_runs,
                      by = c("year", "scenario", "iteration"),
                      suffix = c("_em", "_om")) %>%
  mutate(across(
    .cols = where(is.numeric) & ends_with("_om"),
    .fns = ~ {
      # Get the name of the corresponding '_em' column
      em_col_name <- str_replace(cur_column(), "_om", "_em")
      # Get the value from the '_em' column for the current row
      em_value <- get(em_col_name)
      # Get the value from the current '_om' column (represented by .x)
      om_value <- .x

      # Conditional logic:
      # If both '_em' and '_om' values are 0, set the ratio to 1.
      # Otherwise, perform the division.
      if_else(em_value == 0 & om_value == 0, 1, if_else(om_value == 0, em_value/0.001, em_value / om_value))
    },
    .names = "{str_remove(.col, '_om')}_ratio"
  )) %>%
  select(year, scenario, iteration, model_run = model_run_em, ends_with("_ratio"))

```


```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1_ratio, F_2_ratio, F_3_ratio, F_4_ratio, F_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year,
      ratio_F = if_else(fleet == "F_3", 1, ratio_F)
    ) %>%
  mutate( #used to color by final 3 or 6 years.  
    years_group = case_when(
      years_until_terminal <= 3 ~ "0-3",
      years_until_terminal > 3 & years_until_terminal <= 6 ~ "3-6",
      years_until_terminal > 6 ~ "6+",
      TRUE ~ "Other" # This catch-all is good practice
    )
  )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = ratio_F, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years") +
    facet_wrap( ~ fleet) +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each figure
for (q in 1:length(f_ts_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', f_ts_plots[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(f_ts_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

Figure 10. Each fleet's fishing mortality ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  F_5 is consistently underestimated, it is more underestimated in future years where there is less data.  

## F_5

A zoomed in look at just F_5 from the previous plots.  

```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1_ratio, F_2_ratio, F_3_ratio, F_4_ratio, F_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year,
      ratio_F = if_else(fleet == "F_3", 1, ratio_F)
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) %>%
    filter(fleet == "F_5")
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    filter(fleet == "F_5") %>%
    ggplot() +
    geom_point(aes(y = ratio_F, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years") +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each figure
for (q in 1:length(f_ts_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', f_ts_plots[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(f_ts_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

Figure 11. Red tide mortality ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  Red tide mortality is consistently underestimated, it is more underestimated in future years where there is less data.  

## F.Value from dqs

```{r}

#set up the OM and EM dataframes, join them, and calculate the EM:OM ratio for each available value

ratio_df_dq <- left_join(EM_runs_dq, OM_runs_dq,
                      by = c("year", "scenario", "iteration"),
                      suffix = c("_em", "_om")) %>%
  mutate(across(
    .cols = where(is.numeric) & ends_with("_om"),
    .fns = ~ {
      # Get the name of the corresponding '_em' column
      em_col_name <- str_replace(cur_column(), "_om", "_em")
      # Get the value from the '_em' column for the current row
      em_value <- get(em_col_name)
      # Get the value from the current '_om' column (represented by .x)
      om_value <- .x

      # Conditional logic:
      # If both '_em' and '_om' values are 0, set the ratio to 1.
      # Otherwise, perform the division.
      if_else(em_value == 0 & om_value == 0, 1, em_value / om_value)
    },
    .names = "{str_remove(.col, '_om')}_ratio"
  )) %>%
  select(year, scenario, iteration, model_run = model_run_em, ends_with("_ratio"))

```

```{r}


plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df_dq %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(Value.F_ratio, na.rm = TRUE),
      lower_quartile = quantile(Value.F_ratio, 0.25, na.rm = TRUE),
      upper_quartile = quantile(Value.F_ratio, 0.75, na.rm = TRUE)
    )
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = Value.F_ratio, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years") +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each figure
for (q in 1:length(f_ts_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', f_ts_plots[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(f_ts_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

## Biomass

```{r}

plot_biomass_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(retainB_1_ratio, retainB_2_ratio, retainB_3_ratio, retainB_4_ratio, deadB_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_Biomass") %>%
    mutate(fleet = str_sub(fleet, start = 9, end = 9)) %>%
    select(fleet, year, ratio_Biomass, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year,
      ratio_Biomass = if_else(fleet == "3", 1, ratio_Biomass), 
      fleet = if_else(fleet == "r", "5", fleet)
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_Biomass, na.rm = TRUE),
      lower_quartile = quantile(ratio_Biomass, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_Biomass, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = ratio_Biomass, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of Biomass (EM:OM)") + xlab("Years") +
    facet_wrap(~fleet) +
    theme_bw()
  
  rt_terminal_ratio
  
}

biomass_ts_plots <- map(scen_list, plot_biomass_ts)

```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each figure
for (q in 1:length(biomass_ts_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', biomass_ts_plots[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(biomass_ts_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

Figure 12. Biomass ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  Red tide mortality is consistently underestimated, it is more underestimated in future years where there is less data.  

## Recruitment

```{r, warning=FALSE}
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, Recruit_0_ratio, iteration, model_run, scenario) %>%
    rename(ratio_recruitment = Recruit_0_ratio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_recruitment, na.rm = TRUE),
      lower_quartile = quantile(ratio_recruitment, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_recruitment, 0.75, na.rm = TRUE)
    ) 
  
  
  recruitment_ratio_plot <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = ratio_recruitment, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("Recruitment Ratios") +
    ylab("Ratio of recruitment (EM:OM)") + xlab("Years") +
    ylim(c(0,5))+
    facet_wrap(~scenario) +
    theme_bw()
  
  recruitment_ratio_plot

```

Figure 13. Recruitment ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  Recruitment is not over or underestimated, but there are a few outliers where the EM overestimated by 10x.   

## SSB

```{r, warning=FALSE}
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, SpawnBio_ratio, iteration, model_run, scenario) %>%
    rename(ratio_ssb = SpawnBio_ratio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    # Group by year to calculate stats for each year
    group_by(year, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = median(ratio_ssb, na.rm = TRUE),
      lower_quartile = quantile(ratio_ssb, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_ssb, 0.75, na.rm = TRUE)
    ) 
  
  
  ssb_ratio_plot <- fleet_ratios %>%
    ggplot() +
    geom_point(aes(y = ratio_ssb, year),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(year, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, year),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("SSB Ratios") +
    ylab("Ratio of SSB (EM:OM)") + xlab("Years") +
    facet_wrap(~scenario) +
    theme_bw()
  
  ssb_ratio_plot

```

Figure 14. SSB ratio (EM:OM) over time by scenario.  The line indicates the median and the ribbon is the 25-75% quartiles.  SSB is not over or underestimated, but it is more likely to be overestimated, the later years are overestimated.   SSB may spike in response to red tide events based on the red_tide_regular_5_mortality_5 scenario.  

# Terminal Year

Plotting the same ratios as above but by the "time from the terminal year" instead of year.  These plots use mean instead of median because there were too many "years until terminal" with no red tide which skewed to 1 and resulted in straight lines.  F_5 in all of these plots was a straight line when median was used.  

## Fishing Mortality

```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1_ratio, F_2_ratio, F_3_ratio, F_4_ratio, F_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year,
      ratio_F = if_else(fleet == "F_3", 1, ratio_F)
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    # Group by year to calculate stats for each year
    group_by(years_until_terminal, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    ggplot() +
    geom_point(aes(y = ratio_F, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years from terminal") +
    facet_wrap( ~ fleet) +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each figure
for (q in 1:length(f_ts_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', f_ts_plots[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(f_ts_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

Figure 15. Each fleet's fishing mortality ratio (EM:OM) over the years from terminal year by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  F_5 is consistently underestimated, there is higher variation where there is less data.  

## F_5

A zoomed in look at just F_5 from the previous plots.  

```{r}

plot_f_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(F_1_ratio, F_2_ratio, F_3_ratio, F_4_ratio, F_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_F") %>%
    mutate(fleet = str_sub(fleet, start = 1, end = 3)) %>%
    select(fleet, year, ratio_F, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year,
      ratio_F = if_else(fleet == "F_3", 1, ratio_F)
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    # Group by years_until_terminal to calculate stats for each year
    group_by(years_until_terminal, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_F, na.rm = TRUE),
      lower_quartile = quantile(ratio_F, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_F, 0.75, na.rm = TRUE)
    ) %>%
    filter(fleet == "F_5")
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    filter(fleet == "F_5") %>%
    ggplot() +
    geom_point(aes(y = ratio_F, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of F (EM:OM)") + xlab("Years from terminal") +
    theme_bw()
  
  rt_terminal_ratio
  
}

f_ts_plots <- map(scen_list, plot_f_ts)

```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each figure
for (q in 1:length(f_ts_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', f_ts_plots[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(f_ts_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

Figure 16. Red tide mortality ratio (EM:OM) over the years from terminal year by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  F_5 is consistently underestimated, there is higher variation where there is less data.  


## Biomass

```{r}

plot_biomass_ts <- function(scen) {
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      scenario == scen,
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    pivot_longer(c(retainB_1_ratio, retainB_2_ratio, retainB_3_ratio, retainB_4_ratio, deadB_5_ratio),
                 names_to = "fleet",
                 values_to = "ratio_Biomass") %>%
    mutate(fleet = str_sub(fleet, start = 9, end = 9)) %>%
    select(fleet, year, ratio_Biomass, iteration, model_run) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year,
      ratio_Biomass = if_else(fleet == "3", 1, ratio_Biomass), 
      fleet = if_else(fleet == "r", "5", fleet)
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    # Group by year to calculate stats for each year
    group_by(years_until_terminal, fleet) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_Biomass, na.rm = TRUE),
      lower_quartile = quantile(ratio_Biomass, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_Biomass, 0.75, na.rm = TRUE)
    ) 
  
  
  rt_terminal_ratio <- fleet_ratios %>%
    filter(years_until_terminal > 0) %>%
    ggplot() +
    geom_point(aes(y = ratio_Biomass, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle(scen) +
    ylab("Ratio of Biomass (EM:OM)") + xlab("Years from terminal") +
    facet_wrap(~fleet) +
    theme_bw()
  
  rt_terminal_ratio
  
}

biomass_ts_plots <- map(scen_list, plot_biomass_ts)

```

::: {.panel-tabset}

```{r, results='asis'}

# Loop through the list and print each figure
for (q in 1:length(biomass_ts_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', biomass_ts_plots[[q]]$labels$title, '\n\n') 
  
  # 2. Print the table content using kable
  print(biomass_ts_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

Figure 17. Biomass ratio (EM:OM) over the years from terminal year by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  Red tide mortality is consistently underestimated, it is more underestimated in years where there is less data.  

## Recruitment

```{r, warning=FALSE}

  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, Recruit_0_ratio, iteration, model_run, scenario) %>%
    rename(ratio_recruitment = Recruit_0_ratio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0 ) %>%
    # Group by year to calculate stats for each year
    group_by(years_until_terminal, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_recruitment, na.rm = TRUE),
      lower_quartile = quantile(ratio_recruitment, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_recruitment, 0.75, na.rm = TRUE)
    ) 
  
  
  recruitment_ratio_plot <- fleet_ratios %>%
    filter(years_until_terminal > 0 ) %>%
    ggplot() +
    geom_point(aes(y = ratio_recruitment, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("Recruitment Ratios") +
    ylab("Ratio of recruitment (EM:OM)") + xlab("Years from terminal") +
    facet_wrap(~scenario) +
    theme_bw()
  
  recruitment_ratio_plot

```

Figure 18. Recruitment ratio (EM:OM) over time by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  Recruitment is overestimated in the terminal year of the model run.  

## SSB

```{r, warning=FALSE}
  
  fleet_ratios <- ratio_df %>%
    filter(
      # only looking at the projection
      year >= 2017,
      # one scenario at a time
      # exclude init
      !str_detect(model_run, "init")
    ) %>% 
    select(year, SpawnBio_ratio, iteration, model_run, scenario) %>%
    rename(ratio_ssb = SpawnBio_ratio) %>%
    mutate(
      end_year = as.numeric(str_extract(model_run, "\\d{4}$"))+3,
      years_until_terminal = end_year - year
    )
  
  rt_summary <- fleet_ratios %>%
    filter(years_until_terminal > 0 ) %>%
    # Group by year to calculate stats for each year
    group_by(years_until_terminal, scenario) %>%
    # Calculate the median and the 25th/75th percentiles for the ribbon
    reframe(
      median_ratio = mean(ratio_ssb, na.rm = TRUE),
      lower_quartile = quantile(ratio_ssb, 0.25, na.rm = TRUE),
      upper_quartile = quantile(ratio_ssb, 0.75, na.rm = TRUE)
    ) 
  
  
  ssb_ratio_plot <- fleet_ratios %>%
    filter(years_until_terminal > 0 ) %>%
    ggplot() +
    geom_point(aes(y = ratio_ssb, years_until_terminal),
               color = "grey",
               alpha = 0.5) + # Individual points
    # Add the error ribbon using the summary data
    geom_ribbon(
      data = rt_summary,
      aes(years_until_terminal, ymin = lower_quartile, ymax = upper_quartile),
      fill = "lightblue",
      alpha = 0.7
    ) +
    # Add the median line using the summary data
    geom_line(
      data = rt_summary,
      aes(y = median_ratio, years_until_terminal),
      linewidth = 1,
      color = "black"
    ) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) +
    ggtitle("SSB Ratios") +
    ylab("Ratio of SSB (EM:OM)") + xlab("Years from terminal") +
    facet_wrap(~scenario) +
    theme_bw()
  
  ssb_ratio_plot

```

Figure 19. SSB ratio (EM:OM) over the years from the terminal year by scenario.  The line indicates the mean and the ribbon is the 25-75% quartiles.  SSB is underestimated when red tide is introduced, with higher variability in the terminal year of the default model.  

# Management Terms

## Line Plots

```{r}

# identify the last year sampled by SSMSE
max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
  summary$ts$model_run %>%
    unique() %>% # get the list of unique model runs
    str_sub(-4) %>% # select last 4 characters of EM names
    {
      ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
    } %>% # check the last 4 characters are numbers or make NA
    max(na.rm = TRUE) # find the max EM year
)
  
# make a list that includes the OM and all max_sample_year EMs
key_models <- unique(summary$ts$model_run)

color_values <- setNames(ifelse(grepl("OM", key_models), "#D65F00", "black"), key_models)

scen_ts_plots <- function(scen = "default"){

  scen_ts <- summary$ts %>%
    filter(scenario == scen) %>%
    mutate(retainB_all = select(., starts_with("retainB")) %>% rowSums()) %>%
    pivot_longer(cols = c("SpawnBio", "F_5", "retainB_all"),
                 names_to = "variables") %>%
    select(year, value, variables, iteration, model_run)
  
  scen_dq <- summary$dq %>%
    filter(scenario == scen) %>%
    pivot_longer("Value.SPRratio", names_to = "variables") %>%
    select(year, value, variables, iteration, model_run)

  scen_merge <- rbind(scen_ts,scen_dq)
    
t_plot <- scen_merge %>%
  ggplot(aes(x = year, y = value)) +
  geom_line( aes(linetype = as.character(iteration), color = model_run))+
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
  geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
  facet_wrap(~variables, ncol = 1, scales = "free") +
  scale_color_manual(values = color_values) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE, color = FALSE) +
  labs(color = "Model Runs") +
  ggtitle("", subtitle = "Long-term")+
  theme_bw()

scen_years = c(2020,2023,2026, "OM")

t_plot_short <- scen_merge %>%
  filter(str_detect(model_run, str_c(scen_years, collapse = "|"))) %>%
  ggplot(aes(x = year, y = value)) +
  geom_line( aes(linetype = as.character(iteration), color = model_run))+
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
  geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
  facet_wrap(~variables, ncol = 1, scales = "free") +
  scale_color_manual(values = color_values) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE, color=FALSE) +
  labs(color = "Model Runs") +
  coord_cartesian(xlim = c(2000, 2030))+
  ggtitle(scen, subtitle = "Short-term")+
  theme_bw()

t_plot_short + t_plot
  
}

all_term_plots<- map(scen_list, scen_ts_plots)

```

::: {.panel-tabset}

```{r, results='asis', warning = FALSE}

# Loop through the list and print each figure
for (q in 1:length(all_term_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', scen_list[q], '\n\n') 
  
  # 2. Print the table content using kable
  print(all_term_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

Figure 20. Term plots are meant to be a "short term" (2000-2030) and "long term" (1989-2067) look at a few key parameters from the time series dataset.  These plots demonstrate that red tide events correspond with SPR Ratio spikes, and can slowly decrease retained biomass or spawning biomass in the short term.  In the long term, there are no trends.  

## Point Plots

```{r}

# identify the last year sampled by SSMSE
max_sample_year <- suppressWarnings(  #suppress warning because max removes NAs
  summary$ts$model_run %>%
    unique() %>% # get the list of unique model runs
    str_sub(-4) %>% # select last 4 characters of EM names
    {
      ifelse(grepl("^\\d{4}$", .), as.numeric(.), NA)
    } %>% # check the last 4 characters are numbers or make NA
    max(na.rm = TRUE) # find the max EM year
)
  
# make a list that includes the OM and all max_sample_year EMs
key_models <- unique(summary$ts$model_run)

color_values <- setNames(ifelse(grepl("OM", key_models), "#D65F00", "grey"), key_models)

scen_ts_plots <- function(scen = "default"){

  scen_ts <- summary$ts %>%
    filter(scenario == scen) %>%
    mutate(retainB_all = select(., starts_with("retainB")) %>% rowSums()) %>%
    pivot_longer(cols = c("SpawnBio", "F_5", "retainB_all"),
                 names_to = "variables") %>%
    select(year, value, variables, iteration, model_run)
  
  scen_dq <- summary$dq %>%
    filter(scenario == scen) %>%
    pivot_longer("Value.SPRratio", names_to = "variables") %>%
    select(year, value, variables, iteration, model_run)

  scen_merge <- rbind(scen_ts,scen_dq)
    
t_plot <- scen_merge %>%
  ggplot(aes(x = year, y = value)) +
  geom_point( aes(color = model_run), alpha = 0.2)+
  stat_summary(fun = median, geom = "line",  aes(color = model_run),  linewidth = 1.2) +
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
  geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
  facet_wrap(~variables, ncol = 1, scales = "free") +
  scale_color_manual(values = color_values) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE, color = FALSE) +
  labs(color = "Model Runs") +
  ggtitle("", subtitle = "Long-term")+
  theme_bw()

scen_years = c(2020,2023,2026, "OM")

t_plot_short <- scen_merge %>%
  filter(str_detect(model_run, str_c(scen_years, collapse = "|"))) %>%
  ggplot(aes(x = year, y = value)) +
  geom_point(aes(color = model_run))+
  stat_summary(fun = median, geom = "line",  aes(color = model_run),  linewidth = 1.2) +
  geom_vline(xintercept = dat$endyr, color = "gray") +
  geom_vline(xintercept = 2005, color = "gray", linetype = "dashed") +
  geom_vline(xintercept = 2014, color = "gray", linetype = "dashed") +
  facet_wrap(~variables, ncol = 1, scales = "free") +
  scale_color_manual(values = color_values) +
  scale_linetype_manual(values = rep("solid", 100)) +
  guides(linetype = FALSE, color=FALSE) +
  labs(color = "Model Runs") +
  coord_cartesian(xlim=c(2017, 2027))+
  ggtitle(scen, subtitle = "Management Term")+
  theme_bw()

t_plot_short + t_plot
  
}

all_term_plots<- map(scen_list, scen_ts_plots)

```

::: {.panel-tabset}

```{r, results='asis', warning = FALSE}

# Loop through the list and print each figure
for (q in 1:length(all_term_plots)) {
  # 1. Print the tab name (required for this method)
  cat('###', scen_list[q], '\n\n') 
  
  # 2. Print the table content using kable
  print(all_term_plots[[q]])
  
  # Add a separator to ensure Quarto recognizes distinct outputs
  cat('\n\n') 
}

```

:::

Figure 21. Management Term plots are meant to be a "short term" (2000-2027) and "long term" (1989-2067) look at a few key parameters from the time series dataset.  These plots demonstrate that red tide events correspond with SPR Ratio spikes, and can slowly decrease retained biomass or spawning biomass in the short term.  In the long term, there are no trends.  I tried to add median trend lines for the OM and EM but they aren't very clear because of how the lines are colored.  

# Residual Error Plots

Residuals = EM - OM

This calculation does not have issues with zeros and estimates the error introduced to each variable by the different scenarios.  

::: panel-tabset

### 2047 DeadB

::: panel-tabset

#### All

```{r}

residual_runs <- EM_runs %>%
  filter(
    str_detect(model_run, "_EM_2047")) %>%
  rowwise()%>%
  mutate(commercial = sum(deadB_1, deadB_2), recreational = deadB_4) %>%
  left_join(OM_runs, by = c("year", "scenario", "iteration"), suffix = c("_em", "_om")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    res_Recruit_0 = Recruit_0_em-Recruit_0_om,
    res_F_5 = F_5_em-F_5_om,
    res_SpawnBio = SpawnBio_em-SpawnBio_om,
    com_om = sum(deadB_1_om, deadB_2_om),
    res_com = commercial-com_om,
    res_rec = recreational-deadB_4_om,
    res_dead_5 = deadB_5_em-deadB_5_om,
    res_abundance = Bio_smry_em-Bio_smry_om
  )

residual_runs %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(res_com, res_rec, res_dead_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "res_com" = "Commercial Catch",
        "res_rec" = "Recreational Catch",
        "res_dead_5" = "Red Tide Dead"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  #coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Residuals")

```

#### Scenarios 1-4

``` {r}

residual_runs %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(res_com, res_rec, res_dead_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "res_com" = "Commercial Catch",
        "res_rec" = "Recreational Catch",
        "res_dead_5" = "Red Tide Dead"
      )
  )) %>%
  filter(scenario %in% scen_list[1:4]) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  #coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Residuals")
```

#### Scenarios 6-8

```{r}
residual_runs %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(res_com, res_rec, res_dead_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "res_com" = "Commercial Catch",
        "res_rec" = "Recreational Catch",
        "res_dead_5" = "Red Tide Dead"
      )
  )) %>%
  filter(scenario %in% scen_list[6:8]) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  #coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Residuals")


```

:::

#### Long Term Residual Sums (1980-2050)

```{r}
residual_runs %>% 
  group_by(scenario) %>%
  reframe(sum_res_com = sum(res_com)/10, sum_res_rec = sum(res_rec)/10, sum_res_dead_5 = sum(res_dead_5)/10) %>%
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Commercial Catch Residual Sum", "Recreational Catch Residual Sum", "Red  Tide Discards Residual Sum"),
    align = c("l", "c", "c", "c"), # Align columns (left, center, center, center)
    digits = 0
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )
```

#### Short Term Residual Sums (2017-2022)

```{r}
residual_runs %>% 
  filter(year %in% seq(2017, 2022, 1)) %>%
  group_by(scenario) %>%
  reframe(sum_res_com = sum(res_com)/10, sum_res_rec = sum(res_rec)/10, sum_res_dead_5 = sum(res_dead_5)/10) %>%
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Commercial Catch Residual Sum", "Recreational Catch Residual Sum", "Red  Tide Discards Residual Sum"),
    align = c("l", "c", "c", "c"), # Align columns (left, center, center, center)
    digits = 0
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )

#what year is the mean positive, when does it become negative again?  

```

#### Short Term Residual Proportions (2017-2022)

```{r}

residual_runs_prop <- EM_runs %>%
  filter(
    str_detect(model_run, "_EM_2047")) %>%
  rowwise()%>%
  mutate(commercial = sum(deadB_1, deadB_2), recreational = deadB_4) %>%
  left_join(OM_runs, by = c("year", "scenario", "iteration"), suffix = c("_em", "_om")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    res_Recruit_0 = Recruit_0_em-Recruit_0_om,
    res_F_5 = F_5_em-F_5_om,
    res_SpawnBio = SpawnBio_em-SpawnBio_om,
    com_om = sum(deadB_1_om, deadB_2_om),
    res_com = commercial-com_om,
    res_rec = recreational-deadB_4_om,
    res_dead_5 = deadB_5_em-deadB_5_om,
    res_abundance = Bio_smry_em-Bio_smry_om
  )

residual_runs_prop %>% 
  filter(year %in% seq(2017, 2022, 1)) %>%
  group_by(scenario) %>%
  reframe(
    prop_com = (sum(res_com) / sum(com_om))*100,
    prop_rec = (sum(res_rec) / sum(deadB_4_om))*100,
    prop_red = (sum(res_dead_5) /  sum(deadB_5_om))*100,
    raw_total = (sum(res_com)/10+sum(res_rec)/10+sum(res_dead_5)/10),
    raw_prop = (sum(res_com)+sum(res_rec)+sum(res_dead_5)) /  (sum(com_om)+sum(deadB_4_om) + sum(deadB_5_om)) *100
  ) %>% 
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Commercial Catch Residual Sum (MT)", "Recreational Catch Residual Sum (MT)", "Red Tide Discards Residual Sum (MT)", "Total Removals Residual Sum (MT)", "Proportion of Residuals to Total (%)"),
    align = c("l", "c", "c", "c", "c", "c"), # Align columns (left, center, center, center)
    digits = 2
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )
```

### 2026

```{r}
residual_runs <- EM_runs %>%
  filter(
    str_detect(model_run, "_EM_2026")) %>%
  rowwise()%>%
  mutate(commercial = sum(deadB_1, deadB_2), recreational = deadB_4) %>%
  left_join(OM_runs, by = c("year", "scenario", "iteration"), suffix = c("_em", "_om")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    res_Recruit_0 = Recruit_0_em-Recruit_0_om,
    res_F_5 = F_5_em-F_5_om,
    res_SpawnBio = SpawnBio_em-SpawnBio_om,
    com_om = sum(deadB_1_om, deadB_2_om),
    res_com = commercial-com_om,
    res_rec = recreational-deadB_4_om,
    res_dead_5 = deadB_5_em-deadB_5_om,
    res_abundance = Bio_smry_em-Bio_smry_om
  )

residual_runs %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(res_com, res_rec, res_dead_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "res_com" = "Commercial Catch",
        "res_rec" = "Recreational Catch",
        "res_dead_5" = "Red Tide Dead"
      )
  )) %>%
  #filter(scenario %in% scen_list[1:4]) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  #coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Residuals")
```

#### Long Term Residual Sums (1980-2026)

```{r}
residual_runs %>% 
  filter(scenario %in% scen_list[1:4]) %>%
  group_by(scenario) %>%
  reframe(sum_res_com = sum(res_com), sum_res_rec = sum(res_rec), sum_res_dead_5 = sum(res_dead_5)) %>%
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Commercial Catch Residual Sum", "Recreational Catch Residual Sum", "Red  Tide Discards Residual Sum"),
    align = c("l", "c", "c", "c"), # Align columns (left, center, center, center)
    digits = 0
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )
```

#### Short Term Residual Sums (2017-2022)

```{r}
residual_runs %>% 
  filter(year %in% seq(2017, 2022, 1)) %>%
  group_by(scenario) %>%
  reframe(sum_res_com = sum(res_com)/10, sum_res_rec = sum(res_rec)/10, sum_res_dead_5 = sum(res_dead_5)/10) %>%
  kable(
    # Rename columns directly within kable
    col.names = c("Scenario", "Commercial Catch Residual Sum", "Recreational Catch Residual Sum", "Red  Tide Discards Residual Sum"),
    align = c("l", "c", "c", "c"), # Align columns (left, center, center, center)
    digits = 0
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )

#what year is the mean positive, when does it become negative again?  

```

:::

# Other Error Plots

## Relative Error Plots

Inspired by Wetzel and Punt et al. 2011

I am going to attempt to make their Relative Error Plots.

RE = (E - T) / T

If the RE is NA (T = 0), the RE = 0.  This introduces issues in the _all year scenarios where many of the T values are zero and the E > 0.   

```{r}

ratio_df_re <- left_join(EM_runs, OM_runs,
                      by = c("year", "scenario", "iteration"),
                      suffix = c("_em", "_om")) %>%
  mutate(across(
    .cols = where(is.numeric) & ends_with("_om"),
    .fns = ~ {
      # Get the name of the corresponding '_em' column
      em_col_name <- str_replace(cur_column(), "_om", "_em")
      # Get the value from the '_em' column for the current row
      em_value <- get(em_col_name)
      # Get the value from the current '_om' column (represented by .x)
      om_value <- .x

      # Conditional logic:
      # If both '_em' and '_om' values are 0, set the ratio to 1.
      # Otherwise, perform the division.
      if_else(em_value == 0 & om_value == 0, 1, (em_value-om_value) / om_value)
    },
    .names = "{str_remove(.col, '_om')}_re"
  )) %>%
  select(year, scenario, iteration, model_run = model_run_em, ends_with("_re"))

EM_means <- ratio_df_re %>%
  filter(year >= 2017)


```

::: panel-tabset
### Recruitment

```{r}
recruit <- EM_means %>% ggplot(aes(Recruit_0_re, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0)+
  theme_bw() + 
  ggtitle("Recruitment") + xlab("Relative error")
recruit
```

### SpawnBio

```{r}
spawn <- EM_means %>% 
  ggplot(aes(SpawnBio_re, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("SSB") + xlab("Relative error")
spawn
```

### Com F

```{r}

f_com<-EM_means %>% 
  mutate(f_com_re = F_1_re+F_2_re) %>%
  ggplot(aes(f_com_re, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Commercial Mortality") + xlab("Relative error")
f_com
```

### Rec F

```{r}
f_rec <- EM_means %>% 
  ggplot(aes(F_4_re, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Recreational Mortality") + xlab("Relative error")
f_rec
```

### F_5

Cannot be produced because there are zeros in the OM and EM.  

### Com Catch

```{r}
com_c <- EM_means %>% 
  mutate(re_com = retainB_1_re+retainB_2_re) %>%
  ggplot(aes(re_com, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Commercial Catch (Biomass)") + xlab("Relative error")
com_c
```

### Rec Catch

```{r}

rec_c <- EM_means %>% 
  ggplot(aes(retainB_4_re, scenario)) +
  geom_boxplot() +
  geom_vline(xintercept = 0) +
  theme_bw()+ 
  ggtitle("Recreational Catch (Biomass)") + xlab("Relative error")
rec_c
```

### Red Tide Discards

Cannot be calculated because of zeros in the EM and OM.  

:::


::: panel-tabset

### All relative errors

Figure 21. Relative error plots for each variable of interest zoomed in.  

```{r, warning = FALSE}
recruit <- recruit +
  theme(axis.text.y = element_blank()) 
f_rec <- f_rec +
  theme(axis.text.y = element_blank()) + ggtitle("Rec F")
rec_c <- rec_c +
  theme(axis.text.y = element_blank()) + ggtitle("Rec catch")
spawn <- spawn 
f_com <- f_com  + ggtitle("Com F")
com_c <- com_c  + ggtitle("Com catch")

(spawn + recruit) / (f_com + f_rec) / (com_c + rec_c)

```

### All RE with fixed x values

Figure 22. Relative error plots of each variable of interest on the same patchwork.   

```{r, warning = FALSE, message =FALSE}
recruit <- recruit +
  theme(axis.text.y = element_blank()) + xlim(-1,1)
f_rec <- f_rec +
  theme(axis.text.y = element_blank()) + xlim(-1,1)+ ggtitle("Rec F")
rec_c <- rec_c +
  theme(axis.text.y = element_blank()) + xlim(-1,1)+ ggtitle("Rec catch")
spawn <- spawn + xlim(-1,1)
f_com <- f_com + xlim(-1,1) + ggtitle("Com F")
com_c <- com_c + xlim(-1,1) + ggtitle("Com catch")

(spawn + recruit) / (f_com + f_rec) / (com_c + rec_c)

```

Figure 23. Relative error plots of each variable of interest with fixed x-limits between -1 and 1.  

:::

## MAPE

Mean Average Percentage Error

WARNING: The equation for MAPE = abs(EM-OM)/OM so this can result in NA or Inf when the OM or EM is 0.  This results in incorrect numbers for red tide mortality esspecially in the all_years treatments.  

```{r}

OM_means <- summary$ts %>%
  filter(model_run == paste0(OM_name, "_OM")) %>%
  select(scenario, year, Recruit_0, F_5, SpawnBio, iteration, retainB_1, retainB_2, retainB_4, deadB_5, F_1, F_2, F_4, Bio_smry) %>%
  rowwise() %>%
  mutate(commercial = sum(retainB_1, retainB_2), recreational = retainB_4, com_f = sum(F_1, F_2), rec_f = F_4) %>%
  rename(
    OM_Recruit_0 = Recruit_0,
    OM_F_5 = F_5,
    OM_SpawnBio = SpawnBio, 
    OM_com = commercial, 
    OM_rec = recreational, 
    OM_dead_5 = deadB_5,
    OM_com_f = com_f, 
    OM_rec_f = rec_f,
    OM_abundance = Bio_smry
  )

EM_means_re <- summary$ts %>%
  filter(str_detect(model_run, "_EM_2047")) %>%
  rowwise() %>%
  mutate(
    commercial = sum(retainB_1, retainB_2),
    recreational = retainB_4,
    com_f = sum(F_1, F_2),
    rec_f = F_4
  ) %>%
  left_join(OM_means, by = c("year", "scenario", "iteration")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    re_Recruit_0 = ifelse(
      is.na((Recruit_0 - OM_Recruit_0) / OM_Recruit_0),
      0,
      (Recruit_0 - OM_Recruit_0) / OM_Recruit_0
    ),
    #this put zeros back in.
    re_F_5 = ifelse(is.na((F_5 - OM_F_5) / OM_F_5), 0, (F_5 - OM_F_5) /
                      OM_F_5),
    re_SpawnBio = ifelse(is.na((
      SpawnBio - OM_SpawnBio
    ) / OM_SpawnBio), 0, (SpawnBio - OM_SpawnBio) /
      OM_SpawnBio),
    re_com = ifelse(is.na((commercial - OM_com) / OM_com), 0, (commercial - OM_com) /
                      OM_com),
    re_rec = ifelse(is.na((
      recreational - OM_rec
    ) / OM_rec), 0, (recreational - OM_rec) /
      OM_rec),
    re_dead_5 = ifelse(is.na((deadB_5 - OM_dead_5) / OM_dead_5), 0, (deadB_5 - OM_dead_5) /
                         OM_dead_5),
    re_com_f = ifelse(is.na((com_f - OM_com_f) / OM_com_f), 0, (com_f - OM_com_f) /
                        OM_com_f),
    re_rec_f = ifelse(is.na((rec_f - OM_rec_f) / OM_rec_f), 0, (rec_f - OM_rec_f) /
                        OM_rec_f),
    re_abundance = ifelse(
      is.na((Bio_smry - OM_abundance) / OM_abundance),
      0,
      (Bio_smry - OM_abundance) /
        OM_abundance
    ),
    end_year = as.numeric(str_extract(model_run, "\\d{4}$")) + 3,
    years_until_terminal = end_year - year
  )

EM_means <- summary$ts %>%
  filter(str_detect(model_run, "_EM_2047")) %>%
  rowwise() %>%
  mutate(
    commercial = sum(retainB_1, retainB_2),
    recreational = retainB_4,
    com_f = sum(F_1, F_2),
    rec_f = F_4
  ) %>%
  left_join(OM_means, by = c("year", "scenario", "iteration")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    re_Recruit_0 = ifelse(is.na((
      Recruit_0 - OM_Recruit_0
    ) / OM_Recruit_0), 0, abs((
      Recruit_0 - OM_Recruit_0
    ) / OM_Recruit_0) * 100),
    #this put zeros back in.
    re_F_5 = ifelse(is.na((F_5 - OM_F_5) / OM_F_5), 0, abs((F_5 - OM_F_5) /
                                                             OM_F_5)) * 100,
    re_SpawnBio = ifelse(is.na((
      SpawnBio - OM_SpawnBio
    ) / OM_SpawnBio), 0, abs((
      SpawnBio - OM_SpawnBio
    ) /
      OM_SpawnBio)) * 100,
    re_com = ifelse(is.na((commercial - OM_com) / OM_com), 0, abs((commercial - OM_com) /
                                                                    OM_com)) * 100,
    re_rec = ifelse(is.na((
      recreational - OM_rec
    ) / OM_rec), 0, abs((
      recreational - OM_rec
    ) /
      OM_rec)) * 100,
    re_dead_5 = ifelse(is.na((deadB_5 - OM_dead_5) / OM_dead_5), 0, abs((deadB_5 - OM_dead_5) /
                                                                          OM_dead_5)) * 100,
    re_com_f = ifelse(is.na((com_f - OM_com_f) / OM_com_f), 0, abs((com_f - OM_com_f) /
                                                                     OM_com_f)) * 100,
    re_rec_f = ifelse(is.na((rec_f - OM_rec_f) / OM_rec_f), 0, abs((rec_f - OM_rec_f) /
                                                                     OM_rec_f)) * 100,
    re_abundance = ifelse(
      is.na((Bio_smry - OM_abundance) / OM_abundance),
      0,
      abs(Bio_smry - OM_abundance) /
        OM_abundance
    ) * 100,
    end_year = as.numeric(str_extract(model_run, "\\d{4}$")) + 3,
    years_until_terminal = end_year - year
  )


```

::: panel-tabset

### SSB and Catch, all years

```{r, warning = FALSE, message =FALSE}
EM_means %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_SpawnBio, re_com, re_rec, re_abundance),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "re_SpawnBio" = "Spawning Biomass",
        "re_com" = "Commercial Catch",
        "re_rec" = "Recreational Catch",
        "re_abundance" = "Abundance"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw()+ 
  coord_cartesian(xlim = c(1986, 2044)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")
```

### RT, all years

```{r, warning = FALSE, message =FALSE}
EM_means %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_dead_5, re_F_5),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() +
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")

```

### SSB and Catch, 1980-2030

```{r, warning = FALSE, message =FALSE}
EM_means %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_SpawnBio, re_com, re_rec, re_abundance),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "re_SpawnBio" = "Spawning Biomass",
        "re_com" = "Commercial Catch",
        "re_rec" = "Recreational Catch",
        "re_abundance" = "Abundance"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw()+ 
  xlim(1980, 2030)+
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")
```

### RT, 1980-2030

```{r, warning = FALSE, message =FALSE}
EM_means %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_dead_5, re_F_5),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() +
  xlim(1980, 2030)+
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")
```

### SSB and Catch, 2000-2025


```{r, warning = FALSE, message =FALSE}
EM_means %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_SpawnBio, re_com, re_rec, re_abundance),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "re_SpawnBio" = "Spawning Biomass",
        "re_com" = "Commercial Catch",
        "re_rec" = "Recreational Catch",
        "re_abundance" = "Abundance"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw()+ 
  xlim(2000, 2025)+
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Notes: 
When there is no red tide in the OM, a matching EM results in less error in 2018 and a higher error in 2021.  When there is a red tide in the OM, a matching EM results in less error in 2018 and more error in 2021.  

Misspecifying the model does not increase the error, instead there is more error in 2021 and less error in 2018.  



### RT, 2000-2025

```{r, warning = FALSE, message =FALSE}
EM_means %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_dead_5, re_F_5),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
    geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() +
  xlim(2000, 2025)+
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")

```


### SSB and Catch, 2017-2025


```{r, warning = FALSE, message =FALSE}
EM_means %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_SpawnBio, re_com, re_rec, re_abundance),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "re_SpawnBio" = "Spawning Biomass",
        "re_com" = "Commercial Catch",
        "re_rec" = "Recreational Catch",
        "re_abundance" = "Abundance"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw()+ 
  xlim(2017, 2025)+
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Notes: 
When there is no red tide in the OM, a matching EM results in less error in 2018 and a higher error in 2021.  When there is a red tide in the OM, a matching EM results in less error in 2018 and more error in 2021.  

Misspecifying the model does not increase the error, instead there is more error in 2021 and less error in 2018.  



### RT, 2000-2025

```{r, warning = FALSE, message =FALSE}
EM_means %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_dead_5, re_F_5),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
    geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() +
  xlim(2000, 2025)+
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")

```


:::


## Relative Error

WARNING: The equation for RE = (EM-OM)/OM so this can result in NA or Inf when the OM or EM is 0.  This results in incorrect numbers for red tide mortality especially in the all_years treatments.  

::: panel-tabset

### SSB and Catch, all years

```{r}
EM_means_re %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_SpawnBio, re_com, re_rec),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw()
```

### RT, all years

```{r}
EM_means_re %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_dead_5, re_F_5),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() 

```

### SSB and Catch, 1980-2030

```{r}
EM_means_re %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_SpawnBio, re_com, re_rec),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() +
  xlim(1980, 2030)
```

### RT, 1980-2030

```{r}
EM_means_re %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_dead_5, re_F_5),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() +
  xlim(1980, 2030)

```

### SSB and Catch, 2000-2025


```{r}
EM_means_re %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_SpawnBio, re_com, re_rec),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() +
  xlim(2000, 2025)
```

### RT, 2000-2025

```{r}
EM_means_re %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_dead_5, re_F_5),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(year, value)) +
    geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw() +
  xlim(2000, 2025)

```

### SSB and Catch, 2017-2025


```{r, warning = FALSE, message =FALSE}
EM_means_re %>%
mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt"), "No Red Tide",
      ifelse( grepl("all_yrs", scenario), "All Years Red Tide", 
      "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_all_yrs"), "No Red Tide",
      ifelse(grepl("rep", scenario), "Repeat Red Tide", 
      "2 Years Red Tide")
      )
  ) %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(re_SpawnBio, re_com, re_rec, re_abundance),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "re_SpawnBio" = "Spawning Biomass",
        "re_com" = "Commercial Catch",
        "re_rec" = "Recreational Catch",
        "re_abundance" = "Abundance"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  stat_summary(fun = mean, geom = "line", aes(color = em_model), linewidth = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", aes(fill = em_model), alpha = 0.3) +
  facet_grid(om_model~variable) +
  theme_bw()+ 
  xlim(2017, 2025)+
  labs(color = "EM", fill = "EM", x = "Year", y = "Estimation Error (MAPE)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

:::

# Other Explorations

## Exploring Recruitment

::: panel-tabset
### Recruitment DQ

```{r, echo = FALSE, warning = FALSE}
dq_plot_variable(summary, variable = Value.Recr, run_res_path = run_res_path)
```

### Recruitment TS

"rec_dev" "raw_rec_dev" "Recruit_0"

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, Recruit_0, run_res_path, save = TRUE)
```

### rec_dev TS

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, rec_dev, run_res_path, save = TRUE)
```

### raw rec_dev TS

```{r, echo = FALSE, warning = FALSE}
ts_plot_variable(summary, raw_rec_dev, run_res_path, save = TRUE)
```
:::


## Ro Exploration

Extracted the R0 from SR_LN_R0 from the summary$scalar.  

```{r}

summary$scalar %>%
  select(iteration, scenario, model_run, SR_LN_R0) %>%
  mutate(r0 = exp(SR_LN_R0)) %>%
  ggplot(aes(scenario, r0)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

summary$scalar %>%
  select(iteration, scenario, model_run, SR_LN_R0) %>%
  mutate(r0 = exp(SR_LN_R0)) %>%
  ggplot(aes(scenario, r0)) +
  geom_boxplot(aes(color = model_run)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


```

```{r}

ratio_R0 <- summary$scalar %>%
  select(iteration, scenario, model_run, SR_LN_R0) %>%
  mutate(r0 = exp(SR_LN_R0)) %>%
  select(!SR_LN_R0) %>%
  filter(model_run %in% c(paste0(OM_name, "_OM"), paste0(OM_name, "_EM_2047"))) %>%
  pivot_wider(
      names_from = model_run,  # this will create "OM" and "EM" columns
      values_from = r0
  ) %>%
  rename("OM" = paste0(OM_name, "_OM") , "EM" = paste0(OM_name, "_EM_2047")) %>%
  group_by(scenario, iteration) %>%
  mutate(ratio_R0 = EM/OM)
  
ratio_R0 %>%
  ggplot(aes(scenario, ratio_R0)) +
  geom_boxplot()

```

## Ratios of Rec, SPR, and SSB

EM:OM ratios in the new format for variables that don't have zeros.  

```{r}

ratio_df %>%
  filter(str_detect(model_run, "_EM_2047") | str_detect(model_run, "_OM")) %>%
  mutate(
    em_model = ifelse(
      scenario %in% c("no_rt", "rt_2_x_no_rt", "rt_2_x_no_rt_high"),
      "No Red Tide",
      ifelse(grepl("high", scenario), "2 Years High Red Tide", "2 Years Red Tide")
    ),
    om_model = ifelse(
      scenario %in% c("no_rt", "no_rt_x_rt_2", "no_rt_x_rt_2_high"),
      "No Red Tide",
      ifelse(grepl("high", scenario), "2 Years High Red Tide", "2 Years Red Tide")
    )
  ) %>% 
  # Pivot the data longer
  pivot_longer(
    cols = c(
      SpawnBio_ratio,
      Recruit_0_ratio,
      SPRratio_ratio,
      rec_dev_ratio
    ),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~ recode(
        .x,
        "SpawnBio_ratio" = "SSB",
        "Recruit_0_ratio" = "Recruits",
        "SPRratio_ratio" = "SPR Ratio",
        "rec_dev_ratio" = "Rec. Devs."
      )
    )
  ) %>%
  ggplot(aes(year, value)) +
  geom_vline(
    xintercept = c(2005, 2014, 2018, 2021),
    linetype = "dashed",
    color = "gray"
  ) +
  geom_line(aes(year, value, group = iteration), color = "grey") +
  stat_summary(fun = median, geom = "line") +
  #stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  facet_grid(variable ~ scenario, scales = "free") +
  theme_bw() +
  coord_cartesian(xlim = c(2000, 2025)) +
  labs(color = "EM",
       fill = "EM",
       x = "Year",
       y = "Ratio EM:OM")

```

## Red Tide Year Comparisons

::: panel-tabset

### 2047 Boxplot of F_5

```{r}

# # maybe a boxplot with the OM value across all years and EM values across all years will show how much they match up (or not)
# 
# summary$ts %>%
#   filter(model_run %in% c(paste0(OM_name, "_OM"), paste0(OM_name, "_EM_2047"))) %>%
#   ggplot(aes(factor(year), F_5)) + 
#   geom_boxplot(aes(color = model_run)) + 
#   facet_wrap(~scenario)

# maybe these plots would look nice if I only do 2005, 2014, 2018, 2021 as a demonstration of how well it captures just those 4 years with red tide.  
summary$ts %>%
  filter(model_run %in% c(paste0(OM_name, "_OM"), paste0(OM_name, "_EM_2047")), year %in% c(2005, 2014, 2018, 2021)) %>%
  ggplot(aes(factor(year), F_5)) + 
  geom_boxplot(aes(color = model_run)) + 
  facet_wrap(~scenario) +
  ggtitle("model_run = 2047")
```

### 2023 Boxplot of F_5

```{r}
summary$ts %>%
  filter(model_run %in% c(paste0(OM_name, "_OM"), "default_sigmaR_EM_2023"), year %in% c(2005, 2014, 2018, 2021)) %>%
  ggplot(aes(factor(year), F_5)) + 
  geom_boxplot(aes(color = model_run)) + 
  facet_wrap(~scenario) +
  ggtitle("model_run = 2023")

```

### Table of Mean F_5 by red tide year and scenario

```{r}
summary$ts %>%
  filter(model_run %in% c(paste0(OM_name, "_OM"), paste0(OM_name, "_EM_2047")), year %in% c(2005, 2014, 2018, 2021)) %>%
  group_by(year, model_run, scenario) %>%
  reframe(F_5_mean = mean(F_5), F_5_median = median(F_5), F_5_sd = sd(F_5)) %>%
  select(model_run, year, scenario, F_5_mean) %>%
  pivot_wider(
    names_from = model_run,  
    values_from = F_5_mean         # Optional: Adds a prefix to the new column names
  ) %>%
  # Optional: Rename the columns to match your desired 'TRUE' and 'FALSE' format
  rename(
    'EM_2047' = paste0(OM_name, "_EM_2047"),
    'OM' = paste0(OM_name, "_OM")
  ) %>%
  mutate(Residual = EM_2047 - OM) %>%
  kable(
    # Rename columns directly within kable
    align = c("l", "c", "c", "c", "c"), # Align columns (left, center, center, center)
    digits = 3
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), # Add bootstrap styling
    full_width = FALSE # Don't stretch table to full page width
  )
  
```

### Histogram of red tide years (and 2024)

The OM mean is the solid line, the EM mean is the dashed line.  

```{r}

# what if I did a histogram, with the OM as the line, and the EM as the bars, to see how the EM distribution compares to the OM.  

OM_lines_subset <- OM_lines %>% 
  filter(year %in% c(2005, 2014, 2018, 2021, 2024))
EM_lines_subset <- EM_lines %>% 
  filter(year %in% c(2005, 2014, 2018, 2021, 2024))

EM_runs %>%
  filter(year %in% c(2005, 2014, 2018, 2021, 2024)) %>%
  ggplot(aes(F_5)) +
  geom_histogram(bins = 10) + 
  geom_vline(data = OM_lines_subset, aes(xintercept = F_5_mean)) +
  geom_vline(data = EM_lines_subset, aes(xintercept = F_5_mean), linetype = "dashed") +
  facet_grid(scenario~year) + ggtitle("Histograms of F_5 from EM")

```

:::

## Absolute Error Plots

AE = abs(EM - OM)

This is a unidirectional error.  So we ended up preferring Residual Sums.  But I've kept these plots for reference.  Mean Absolute Error (MAE) and Symmetric Mean Absolute Percentage Error (SMAPE) were removed because they had issues with zeros in the red tide fleet.  

::: panel-tabset

### 2047
```{r}

abs_error <- EM_runs %>%
  filter(
    str_detect(model_run, "_EM_2047")) %>%
  rowwise()%>%
  mutate(commercial = sum(retainB_1, retainB_2), recreational = retainB_4) %>%
  left_join(OM_runs, by = c("year", "scenario", "iteration"), suffix = c("_em", "_om")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    ae_Recruit_0 = abs(Recruit_0_em-Recruit_0_om),
    ae_F_5 = abs(F_5_em-F_5_om),
    ae_SpawnBio = abs(SpawnBio_em-SpawnBio_om),
    com_om = sum(retainB_1_om, retainB_2_om),
    ae_com = abs(commercial-com_om),
    ae_rec = abs(recreational-retainB_4_om),
    ae_dead_5 = abs(deadB_5_em-deadB_5_om),
    ae_abundance = abs(Bio_smry_em-Bio_smry_om)
  )

abs_error %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(ae_com, ae_rec, ae_dead_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "ae_com" = "Commercial Catch",
        "ae_rec" = "Recreational Catch",
        "ae_dead_5" = "Red Tide Dead"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  #coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Absolute Error")

```

### 2026

```{r}

abs_error <- EM_runs %>%
  filter(
    str_detect(model_run, "_EM_2026")) %>%
  rowwise()%>%
  mutate(commercial = sum(retainB_1, retainB_2), recreational = retainB_4) %>%
  left_join(OM_runs, by = c("year", "scenario", "iteration"), suffix = c("_em", "_om")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    ae_Recruit_0 = abs(Recruit_0_em-Recruit_0_om),
    ae_F_5 = abs(F_5_em-F_5_om),
    ae_SpawnBio = abs(SpawnBio_em-SpawnBio_om),
    com_om = sum(retainB_1_om, retainB_2_om),
    ae_com = abs(commercial-com_om),
    ae_rec = abs(recreational-retainB_4_om),
    ae_dead_5 = abs(deadB_5_em-deadB_5_om),
    ae_abundance = abs(Bio_smry_em-Bio_smry_om)
  )

abs_error %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(ae_com, ae_rec, ae_dead_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "ae_com" = "Commercial Catch",
        "ae_rec" = "Recreational Catch",
        "ae_dead_5" = "Red Tide Dead"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  #coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Absolute Error")

```

### 2047 zoomed (2017-2025)
```{r}

abs_error <- EM_runs %>%
  filter(
    str_detect(model_run, "_EM_2047")) %>%
  rowwise()%>%
  mutate(commercial = sum(retainB_1, retainB_2), recreational = retainB_4) %>%
  left_join(OM_runs, by = c("year", "scenario", "iteration"), suffix = c("_em", "_om")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    ae_Recruit_0 = abs(Recruit_0_em-Recruit_0_om),
    ae_F_5 = abs(F_5_em-F_5_om),
    ae_SpawnBio = abs(SpawnBio_em-SpawnBio_om),
    com_om = sum(retainB_1_om, retainB_2_om),
    ae_com = abs(commercial-com_om),
    ae_rec = abs(recreational-retainB_4_om),
    ae_dead_5 = abs(deadB_5_em-deadB_5_om),
    ae_abundance = abs(Bio_smry_em-Bio_smry_om)
  )

abs_error %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(ae_com, ae_rec, ae_dead_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "ae_com" = "Commercial Catch",
        "ae_rec" = "Recreational Catch",
        "ae_dead_5" = "Red Tide Dead"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Absolute Error")

```

### 2047 More Variables

```{r}

abs_error <- EM_runs %>%
  filter(
    str_detect(model_run, "_EM_2047")) %>%
  rowwise()%>%
  mutate(commercial = sum(retainB_1, retainB_2), recreational = retainB_4) %>%
  left_join(OM_runs, by = c("year", "scenario", "iteration"), suffix = c("_em", "_om")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    ae_Recruit_0 = abs(Recruit_0_em-Recruit_0_om),
    ae_F_5 = abs(F_5_em-F_5_om),
    ae_SpawnBio = abs(SpawnBio_em-SpawnBio_om),
    com_om = sum(retainB_1_om, retainB_2_om),
    ae_com = abs(commercial-com_om),
    ae_rec = abs(recreational-retainB_4_om),
    ae_dead_5 = abs(deadB_5_em-deadB_5_om),
    ae_abundance = abs(Bio_smry_em-Bio_smry_om)
  )

abs_error %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(ae_Recruit_0, ae_SpawnBio, ae_F_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "ae_Recruit_0" = "Recruitment",
        "ae_SpawnBio" = "SSB",
        "ae_F_5" = "Red Tide F"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  #coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Absolute Error")

```

### 2047 More variables, zoomed in

```{r}

abs_error <- EM_runs %>%
  filter(
    str_detect(model_run, "_EM_2047")) %>%
  rowwise()%>%
  mutate(commercial = sum(retainB_1, retainB_2), recreational = retainB_4) %>%
  left_join(OM_runs, by = c("year", "scenario", "iteration"), suffix = c("_em", "_om")) %>%
  group_by(scenario, iteration, year) %>%
  mutate(
    ae_Recruit_0 = abs(Recruit_0_em-Recruit_0_om),
    ae_F_5 = abs(F_5_em-F_5_om),
    ae_SpawnBio = abs(SpawnBio_em-SpawnBio_om),
    com_om = sum(retainB_1_om, retainB_2_om),
    ae_com = abs(commercial-com_om),
    ae_rec = abs(recreational-retainB_4_om),
    ae_dead_5 = abs(deadB_5_em-deadB_5_om),
    ae_abundance = abs(Bio_smry_em-Bio_smry_om)
  )

abs_error %>%
  # Pivot the data longer
  pivot_longer(
    cols = c(ae_Recruit_0, ae_SpawnBio, ae_dead_5),
    names_to = "variable",
    values_to = "value",
    names_transform = list(
      variable = ~recode(
        .x,
        "ae_Recruit_0" = "Recruitment",
        "ae_SpawnBio" = "SSB",
        "ae_dead_5" = "Red Tide Dead"
      )
  )) %>%
  ggplot(aes(year, value)) +
  geom_vline(xintercept = c(2005, 2014, 2018, 2021), linetype = "dashed", color = "gray") +
  geom_vline(xintercept = c(2016), color = "gray")+ # should this be the first predicted year?
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_cl_normal, geom = "ribbon", alpha = 0.3) +
  facet_grid(variable~scenario, scales = "free") +
  theme_bw()+ 
  #coord_cartesian(ylim = c(0,3)) +
  coord_cartesian(xlim = c(2017, 2025)) +
  labs(color = "EM", fill = "EM", x = "Year", y = "Absolute Error")

```

:::
